<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head th:include="guangdong/public/resource :: copy"></head>
<body>
<link rel="stylesheet" th:href="${basePath}+'/assets/style/news/news.css'">
<div class="wrapper clearfix">
    <div class="content">
        <!--公共主头部开始-->
        <div id="header" th:include="guangdong/public/header :: copy"></div>
        <!--公共主头部结束-->
        <!--主体开始-->
        <div class="categoryChange">
            <div class="row clearfix">
                <div class="title">区域：</div>
                <div class="adrList" id="areList">

                </div>
            </div>
        </div>
        <div class="filter clearfix">
            <div class="search" style="top: -25px;">
                <input type="text" id="searchValue" onkeydown="if(event.keyCode==13) searchList();" placeholder="输入关键词">
                <a href="javascript:searchList()"><i class="iconfont icon-search"></i></a>
            </div>
        </div>
        <div class="news-main clearfix">

            <div class="left-cont">
                <ul class="bar">

                </ul>
            </div>
            <div class="right-cont">
                <div class="center-nav">
                    <ul class="clearfix">

                    </ul>
                    <input type="hidden" id="searcheKey">
                </div>
                <ul class="new-group" id="modelList">

                </ul>
                <!--分页开始 -->
                <div class="green-black" id="artPagging" style="margin-bottom: 40px"></div>
                <!--分页结束-->
            </div>
        </div>
        <!--主体结束-->
    </div>
</div>
<!--底部开始-->
<div class="footer-container" id="footer" th:include="guangdong/public/footer :: copy"></div>
<!--底部结束-->
<a class="to-top"></a>
<script type="text/javascript" th:inline="javascript">
    var userId = $("#temp_userId").val();
    var column = "",dataId;
    //程序初始化
    $().ready(function () {
        initNav();
        showAre($.cookie("city"));
        dataPage();
    })
    function setActive(dom){
        $(dom).parent('span').addClass("active").siblings().removeClass("active");
    }
    //一级目录切换
    function leftNavChange() {
        $('.left-cont ul li').on('click', function (e) {
            $(this).addClass('active').siblings().removeClass('active');
            dataId = $(this).attr('data-id');
        })
    }
    //二级目录切换
    function topNavChange() {
        if($('.center-nav ul li').size() <= 1){
            $('.center-nav').hide();
        }else{
            $('.center-nav ul li').on('click', function (e) {
                $(this).addClass('active').siblings().removeClass('active');
                dataId = $(this).attr('data-id');
                dataPage();
            })
            $('.center-nav').show();
        }
    }

    //调取菜单AJAX
    function initNav(){
        dataInit.ajax({
            api:[[${apiPath.infcolumn}]],
            fn:function(data){
                if(data && data.rows.length > 0){
                    column = data.rows;
                    createNav(column);
                }
            }
        })
    }
    function searchList() {
        if($("#searchValue").val()){
            var searchValue = removeHTMLTag($("#searchValue").val());
            $("#searcheKey").val(searchValue);
            dataPage();
        }else {
            $("#searcheKey").val("");
            dataPage();
        }
    }

    //查找数据AJAX
    function dataPage(page,rows) {
        var params_page = page || 1;
        var params_rows = rows || 12;
        var params = {
            index:params_page,
            size:params_rows,
            cultid: $.cookie('cultid'),
            deptid: $("#deptid").val(), //部门id
            searcheKey: $("#searcheKey").val(), //搜索
            area: $("#area").val(), //区域
            city: $("#city").val(), //市
            province: $("#province").val(), //省
            type:dataId
        }
        //调用接口
        rongDialog.init({ico: 3, type: 1, desc: '', overTime: 8000});
        dataInit.ajax({
             api: [[${apiPath.infolist}]],
             params: params,
             fn: function(data){
                 rongDialog.closeMaskPanel();
             showModelList(data);
             dataInit.pageInit('artPagging', params_page, params_rows, data.total, dataPage);
             }
         })
    }

    //生成HTML
    function showModelList(data) {
        var modelList = $("#modelList");
        modelList.html("");
        if (data.code == 0) {
            if (data.rows.length > 0) {
                for (var i in data.rows) {
                    var model = data.rows[i];
                    var year = moment(model.clnfcrttime).format('YYYY-MM');
                    var day = moment(model.clnfcrttime).format('DD');
                    var clnfsource = model.clnfsource ? model.clnfsource : "本站点";
                    var clnfkey = model.clnfkey ? model.clnfkey : "无";
                    var clnfintroduce = '无';
                    if(model.clnfintroduce)
                        clnfintroduce = removeHTMLTag(model.clnfintroduce);
                    modelList.append('<li>\
                        <a href="detail?id='+model.clnfid+'" target="_blank"></a>\
                                <h2>'+model.clnftltle+'</h2>\
                            <p>\
                            源自：<span>'+clnfsource+'</span>\
                            关键字：<span>'+clnfkey+'</span>\
                            </p>\
                            <div class="info">'+clnfintroduce+'</div>\
                            <div class="date-cont">\
                                <p class="day">'+day+'</p>\
                                <p class="year">'+year+'</p>\
                            </div>\
                        </li>\
                        ');
                }
            } else {
                modelList.append("<div class='public-no-message'></div>");
            }
        } else {
            rongDialog.init({ico: 2, type: 1, desc: data.msg});
        }
    }

    //生成菜单
    function createNav(data){
        var panel = $('.bar');
        panel.html("");
        for(var i in data){
            var model = data[i];
            if(model.children.length>0){
                if([[${zx_type}]]&&[[${zx_type}]]!=""){
                    if ([[${zx_type}]] == model.id) {
                        panel.append("<li data-id='" + model.children[0].id + "' class='active' onclick='createSctNav(" + i + ")'>" + model.coltitle + "</li>");
                        createSctNav(i);
                    } else {
                        panel.append("<li data-id='" + model.children[0].id + "' onclick='createSctNav(" + i + ")'>" + model.coltitle + "</li>");
                    }
                }else {
                    if (i == 0) {
                        panel.append("<li data-id='" + model.children[0].id + "' class='active' onclick='createSctNav(" + i + ")'>" + model.coltitle + "</li>");
                        createSctNav(i);
                    } else {
                        panel.append("<li data-id='" + model.children[0].id + "' onclick='createSctNav(" + i + ")'>" + model.coltitle + "</li>");
                    }
                }
            }
        }
        leftNavChange();
    }

    //生成二级菜单
    function createSctNav(index){
        var sctPanel = $('.center-nav ul');
        sctPanel.html("");
        var data = column[index].children;
        if(data){
            for(var i in data){
                var model = data[i];
                if(i == 0){
                    dataId = model.id;
                    sctPanel.append("<li data-id='"+model.id+"' class='active'>"+model.coltitle+"</li>");
                }else{
                    sctPanel.append("<li data-id='"+model.id+"'>"+model.coltitle+"</li>");
                }
            }
            topNavChange();
            dataPage();
        }
    }

    //给消息过滤HTML标签
    function removeHTMLTag(str) {
        str = str.replace(/<\/?[^>]*>/g,''); //去除HTML tag
        str = str.replace(/[ | ]*\n/g,'\n'); //去除行尾空白
        //str = str.replace(/\n[\s| | ]*\r/g,'\n'); //去除多余空行
        str=str.replace(/&nbsp;/ig,'');//去掉&nbsp;
        return str;
    }
</script>
</body>
</html>