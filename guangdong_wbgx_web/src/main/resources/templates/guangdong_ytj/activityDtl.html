<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head th:include="guangdong_ytj/public/header :: copy"></head>
<link rel="stylesheet" th:href="${basePath}+'/assets/css/digitDtl.css'">
<script th:src="${apiPath.myvisitnote}" id="whgtongji"></script>
<body class="mui-content">

<header>
    <div class="black"><i class="mui-icon mui-icon-arrowleft"></i> 返回</div>
</header>

<main class="mui-content">
    <div class="title" id="dtl_title"></div>
    <div class="content">
        <div>
            <div class="title_">
                <span></span>
                活动详情
            </div>
            <div class="msg clearfix" id="dtl_info"></div>
        </div>
        <div>
            <div class="title_">
                <span></span>
                相关资讯
            </div>
            <div class="msg clearfix" id="dtl_rel_info"></div>
        </div>
    </div>
    <div class="img_box" id="resource_box">
        <ul id="resourceNav"></ul>
        <div class="img_ clearfix" id="images_box"></div>
        <div class="img_ clearfix" id="videos_box"></div>
        <div class="img_ clearfix" id="audios_box"></div>
        <!--<div class="img_ clearfix" id="files_box"></div>-->
    </div>
</main>

<div class="qrCode">
    <div>
        <div>
            <div id="qrCode_"></div>
        </div>
        <div>
            请扫描二维码，
            微信登陆后预定。
        </div>
    </div>
</div>

<div class="videoView">
    <div class="box">
        <span class="close iconfont icon-close"></span>
        <video id="video___" autoplay="autoplay" loop="loop" controls="controls" controlsList="nodownload"></video>
    </div>
</div>
<div class="audioView">
    <div class="box">
        <span class="close iconfont icon-close"></span>
        <audio id="audio___" autoplay controls="controls" controlsList="nodownload"></audio>
    </div>
</div>

<script th:inline="javascript">

    function init() {
        var id = getUrlParam('id');
        $('#qrCode_').qrcode({
            width:  240,
            height: 240,
            text: [[${yuMing}]]+"wechat/act/detail?id="+id
        });
        getDZSC();
        //getDetail();
        bindEvent();
    }

    init();

    function getDetail(sc,dz) {
        var param = {};
        param.actId = getUrlParam('id');
        param.cultid = $.cookie('cultid');
        for(var k in param){
            if (!param[k] || param[k]=='' || param[k]=='undefined')
                delete param[k];
        }

        // 获取活动详情
        $.post( [[${rootUrl}]] + 'api/activity/detail' ,param,function (r) {
            var data = JSON.parse(r);
            if(data.code == '0'){
                var dtl = data.data.actdetail;
                var imgUrl = data.imgPath + dtl.imgurl;
                var state = '';
                var liststate = data.data.liststate;
                if(liststate == 1){
                    state = '<div class="btn" id="order">立即预定</div>' ;
                }else if(liststate == 2){
                    state = '<div class="btn disabled" id="order">已订完</div>' ;
                }else if(liststate == 3){
                    state = '' ;
                }else if(liststate == 4){
                    state = '<div class="btn disabled" id="order">活动已结束</div>' ;
                }else{
                    state = '<div class="btn disabled" id="order">即将开始</div>' ;
                }

                //活动时间
                var begin = new Date(dtl.starttime).format('yyyy-MM-dd');
                var end = new Date(dtl.endtime).format('yyyy-MM-dd');
                //报名时间
                var regBegin = new Date(dtl.enterstrtime).format('yyyy-MM-dd');
                var regEnd = new Date(dtl.enterendtime).format('yyyy-MM-dd');

                var html = '<img src="'+imgUrl+'">' +
                    '            <span class="label">'+dtl.etype+'</span>' +
                    '        <div class="btn_group clearfix">' +
                    (liststate == '4' ? '' : '<div class="label_">余票 <a>'+data.data.ticketnum+'</a> 张</div>')+
                    '            <div class="zan"><i class="iconfont icon-praise"></i>点赞（'+dz+'）</div>' +
                    '            <div class="like"><i class="iconfont icon-like"></i>收藏（'+sc+'）</div>'
                    + state +
                    '        </div>' +
                    '        <div class="title_">'+dtl.name+'<span id="visitCount">浏览量：</span></div>' +
                    '        <div class="footer">' +
                    '            <div class="items">' +
                    '                报名时间：'+ regBegin +' 至 '+ regEnd +
                    '            </div>' +
                    '            <div class="items">' +
                    '                活动时间：'+ begin +' 至 '+ end +
                    '            </div>' +
                    '            <div class="items">' +
                    '                活动地点：'+ dtl.address +
                    '            </div>' +
                    '            <div class="items">' +
                    '                联系电话：'+ dtl.telephone +
                    '            </div>' +
                    '        </div>';
                $('#dtl_title').html(html);
                $('#dtl_info').html(dtl.remark);

                // 浏览量
                getVisitSumCount4url(getUrlParam('id'), function(count){
                    $('#visitCount').text('浏览量：'+count);
                });
            }else{
                mui.alert(data.msg);
            }
        });

        // 获取活动相关资讯资源
        $.post( [[${rootUrl}]] + 'api/comm/glzx' ,{
            entityid: param.actId,
            clnftype: '2016111900000018'
        },function (r) {
            var data = JSON.parse(r);
            if(data.code == '0'){
                if(data.data.length){
                    var html = '';
                    $.each(data.data,function (i, v) {
                        var date = new Date(v.clnfopttime).format('yyyy-MM-dd');
                        html+='<div class="text" data-id="'+ v.clnfid +'">' + v.clnftltle +
                            '<span class="left_">来源：'+ v.clnfsource +'</span>' +
                            '<span class="right_">时间：'+ date +'</span>' +
                            '</div>';
                        if(i>10)return false;
                    });
                    $('#dtl_rel_info').html(html);
                }else{
                    $('#dtl_rel_info').parent().hide();
                }
            }else{
                mui.alert(data.msg);
            }
        });
        $.post( [[${rootUrl}]] + 'api/comm/resource' ,{
            refid: param.actId,
            reftype: 4
        },function (r) {
            var data = JSON.parse(r);
            var imgPath = data.imgPath;
            if(data.code == '0'){
                if(data.data.length){
                    var image = '';
                    var video = '';
                    var audio = '';
                    var files = '';
                    var imgUrl= '';
                    $.each(data.data,function (i, v) {
                        if(v.enttype == '1'){
                            imgUrl = v.enturl.indexOf('http://')>=0 ? v.enturl : imgPath + v.enturl;
                            image += '<div data-id="'+ v.id +'">' +
                                '<img src="'+ imgUrl +'" data-preview-src data-preview-group="1">' +
                                '<h5>'+v.name+'</h5>' +
                                '</div>';
                        }
                        if(v.enttype == '2'){
                            imgUrl = v.deourl.indexOf('http://')>=0 ? v.deourl : imgPath + v.deourl;
                            video += '<div data-id="'+ v.id +'" data-src="'+ v.enturl +'">' +
                                '<img src="'+ imgUrl +'">' +
                                '<h5>'+v.name+'</h5>' +
                                '</div>';
                        }
                        if(v.enttype == '3'){
                            audio += '<div data-id="'+ v.id +'" data-src="'+ v.enturl +'">' +
                                '<img src="'+[[${basePath}]]+'/assets/imac/img/mp3.jpg">' +
                                '<h5>'+v.name+'</h5>' +
                                '</div>';
                        }
                        if(v.enttype == '4'){
                            files += '<div data-id="'+ v.id +'" data-src="'+ v.enturl +'">' +
                                '<img src="'+[[${basePath}]]+'/assets/imac/img/mp3.jpg">' +
                                '<h5>'+v.name+'</h5>' +
                                '</div>';
                        }
                        if(i>10)return false;
                    });
                    var resourceNav = '';
                    if(image){
                        resourceNav += '<li data-fn="images">活动图片</li>';
                    }
                    if(audio){
                        resourceNav += '<li data-fn="audios">活动音频</li>';
                    }
                    if(video){
                        resourceNav += '<li data-fn="videos">活动视频</li>';
                    }
                    /*if(files){
                        resourceNav += '<li data-fn="files">活动文件</li>';
                    }*/
                    $('#resourceNav').html(resourceNav).find('li:first-child').addClass('active').trigger('tap');
                    $('#images_box').html(image);
                    $('#videos_box').html(video);
                    $('#audios_box').html(audio);
                    // $('#files_box').html(files);
                    mui.previewImage();
                }else{
                    $('#resource_box').hide();
                }
            }else{
                $('#resource_box').hide();
                // mui.alert(data.msg);
            }
        });

    }

    // 获取收藏数,点赞数
    function getDZSC() {
        var id = getUrlParam('id');
        $.post( [[${rootUrl}]] + 'api/comm/isLightenColle',{cmrefid:id,cmreftyp:4},function (r) {
            var data = JSON.parse(r);
            if(data.code=='0'){
                var sc = data.data.scNum;
                $.post( [[${rootUrl}]] + 'api/comm/isLightenGood',{cmrefid:id,cmreftyp:4},function (r) {
                    var data = JSON.parse(r);
                    if(data.code=='0'){
                        var dz = data.data.num;
                        getDetail(sc,dz);
                    }
                });
            }
        });

    }

    function bindEvent() {

        $('#dtl_title').on('tap','#order',function () {
            if($(this).hasClass('disabled')) return false;
            $('.qrCode').show().addClass('active');
        });

        $('.qrCode').on('tap',function (e) {
            var tar = e.target.className;
            if(tar.indexOf('qrCode')>=0) $(this).removeClass('active').hide();

        });

        $('.black').on('tap',function () {
            var from = getUrlParam('from');
            if(window.sessionStorage.back){
                var href_ = window.sessionStorage.back;
                window.sessionStorage.back = '';
                return location.href = href_;
            }
            if(from)return location.href = 'index';
            location.href = 'activityList';
        });

        $('#resourceNav').on('tap','li',function () {
            $(this).addClass('active').siblings().removeClass('active');
            var id = $(this).attr('data-fn');
            $('#'+id+'_box').show().siblings('.img_').hide();
        });

        $('#dtl_rel_info').on('tap','.text',function () {
            var id = $(this).attr('data-id');
            window.sessionStorage.back = 'activityDtl?id=' + getUrlParam('id');
            location.href = 'infoDtl?id=' + id;
        });

        var player_ ;
        $('#videos_box').on('tap','div',function () {
            var src = $(this).attr('data-src');
            /*var videoObject = {
                container: '#video___',//“#”代表容器的ID，“.”或“”代表容器的class
                variable: 'player_',//该属性必需设置，值等于下面的new chplayer()的对象
                flashplayer:false,//如果强制使用flashplayer则设置成true
                loop:true,//	播放结束后是否循环播放
                autoplay:true,//	是否自动播放
                mobileCkControls: true,
                video:src//视频地址
            };
            player_=new ckplayer(videoObject);
            player_.videoPlay();*/
            $('.videoView').show().find('#video___').attr('src',src);
            $('#video___')[0].play();
        });
        $('.videoView').on('tap',function (e) {
            if(e.target.className == 'videoView' || e.target.nodeName == 'SPAN'){
                /*player_.videoPause();
                player_.videoClear();
                player_ = null;*/
                $('#video___')[0].pause();
                $('.videoView').hide();
            }
        });

        var audio = $('#audio___')[0];
        $('#audios_box').on('tap','div',function () {
            $('.audioView').show();
            var src = $(this).attr('data-src');
            $(audio).attr('src',src);
        });
        $('.audioView').on('tap',function (e) {
            if(e.target.className == 'audioView' || e.target.nodeName == 'SPAN'){
                audio.pause();
                $('.audioView').hide();
            }
        });

    }

</script>

</body>
</html>
