<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head th:include="guangdong_gx/public/resource :: copy"></head>
<body>
<script th:src="${basePath}+'/assets/common/js/whg.maps.js'"></script>
<script th:src="${basePath}+'/assets/js/public/sly.js'"></script>
<script type="text/javascript">
    $(function(){
        $('a[href*=#],area[href*=#]').click(function() {
            if (location.pathname.replace(/^\//, '') == this.pathname.replace(/^\//, '') && location.hostname == this.hostname) {
                var $target = $(this.hash);
                $target = $target.length && $target || $('[name=' + this.hash.slice(1) + ']');
                if ($target.length) {
                    var targetOffset = $target.offset().top;
                    $('html,body').animate({
                            scrollTop: targetOffset
                        },
                        400);
                    return false;
                }
            }
        });
    })
</script>
<div class="wrapper clearfix">
    <div class="content">
        <!--公共主头部开始-->
        <div id="header" th:include="guangdong_gx/public/header :: copy"></div>
        <!--公共主头部结束-->
        <div class="sys-crumbs">
            <span><a href="../res-gx/index">首页</a></span>
            <i class="icon iconfont icon-enter"></i>
            <span><a href="list">活动</a></span>
            <i class="icon iconfont icon-enter"></i>
            <span class="active" id="title"></span>
        </div>
        <div class="sys-main-info">
            <div class="img">
                <img id="imgPath" src="../../assets/img/public/loading.png">
            </div>
            <div class="info">
                <h1 class="_title">&nbsp;</h1>
                <p class="tag-list" id="tag">
                </p>
                <p class="desc">
                    供需次数：<span class="stars-list">
                    </span>
                </p>
                <p class="desc">
                    所属文化馆：<span id="area">&nbsp;</span>
                </p>
                <p class="desc">
                    活动地址：<span id="address">&nbsp;</span>
                </p>
                <p class="desc">
                    活动时间：<span id="times">&nbsp;</span>
                </p>
                <p class="desc">
                    联系电话：<span id="phone">&nbsp;</span>
                </p>
                <p class="desc" style="display: none">
                    活动标签：<span id="_label">&nbsp;</span>
                </p>
                <div class="go-next"><a href="javascript:void(0)">申请配送</a></div>
                <div class="other-cont clearfix">
                    <div class="fav-vote-cont clearfix">
                        <div class="sys-fav" title="收藏"><i class="icon iconfont icon-collection icon-collection_fill" id="fav-btn"></i><span>0</span></div>
                    </div>
                    <div class="sns-cont" title="分享">
                        分享到
                        <a href="javascript:void(0);" class="fxweix"><i class="icon iconfont icon-wechat"></i></a>
                        <a href="javascript:void(0);" class="fxweibo"><i class="icon iconfont icon-xinlang"></i></a>
                        <a href="javascript:void(0);" class="fxqq"><i class="icon iconfont icon-kongjian"></i></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="sys-main-bottom">
            <div class="main-cont clearfix">
                <div class="left-cont">
                    <div class="item-cont" id="show-venue-info">
                        <div class="sys-main-title">
                            <div class="title">供需信息内容</div>
                            <hr>
                        </div>
                        <div class="sys-detail-list">
                            <div class="title">活动简介</div>
                            <div class="html-panel" id="summary"></div>
                        </div>
                        <div class="sys-detail-list" id="rangeContent">
                            <div class="title">配送范围</div>
                            <div class="html-panel" id="range"></div>
                        </div>
                        <div class="sys-detail-list">
                            <div class="title">配送时间</div>
                            <div class="html-panel">
                                <div class="dg-train-info dg-train-table" style="margin-bottom: 20px">
                                    <table>
                                        <tbody id="timeList">
                                        </tbody>
                                    </table>
                                </div>
                                <!--分页开始-->
                                <div class="green-black" id="artPagging" style="margin-bottom: 40px"></div>
                                <!--分页结束-->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="right-cont">
                    <div class="item-cont">
                        <div class="sys-main-title">
                            <div class="title">相关推荐</div>
                            <hr>
                        </div>
                        <div class="recommend-cont">
                            <ul id="Recommend">
                                <!--<li>
                                    <div class="img">
                                        <a href="#">
                                            <img src="../../assets/img/img_demo/demo2017b.jpg">
                                        </a>
                                    </div>
                                    <p>
                                        <a href="#">不过话说text-ellipsis是一个特殊的样式</a>
                                    </p>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--底部开始-->
<div class="footer-container" id="footer" th:include="guangdong_gx/public/footer :: copy"></div>
<!--底部结束-->
<input type="hidden" id="temp_type" value="25">
<div th:include="guangdong_gx/public/fav :: copy"></div>
<a class="to-top"></a>
<script th:src="${basePath}+'/assets/js/field/fieldOrder.js'"></script>
<script type="text/javascript" th:inline="javascript">
    var itemId = dataInit.getUrlParam('id');
    var cultid = $.cookie("cultid");
    var crtuser = '';
    var userid = $("#temp_userId").val();
    var _title = '';
    $(document).ready(function () {
        dataInit.ajax({
            api: [[${apiPath.canApply}]],
            fn: function (data) {
                if(data.data == true){
                        $(".go-next").on("click",function () {
                            window.location.href = [[${basePath}]]+'/res-center/stepOpenDay?id=' + itemId +'&fktype='+fav_type+ '&crtuser='+crtuser+'&title='+encodeURI(encodeURI(_title));
                        })
                }else {
                    $(".go-next").hide();
                }
            },
            params: {id: itemId}
        });
        //供需指数 星星
        dataInit.ajax({
            api: [[${apiPath.showStarts}]],
            fn: showStarts,
            params: {id: itemId}
        });
        //活动信息
        dataInit.ajax({
            api: [[${apiPath.resHdInfo}]],
            fn: showVenueDetail,
            params: {id: itemId}
        });
        //推荐人才列表
        dataInit.ajax({
            api: [[${apiPath.activityRecommends}]],
            fn: recommendList,
            params: {id: itemId,cultid:cultid, size:3}
        });

        //供需配送时间列表
        showTimeList();
        //供需配送范围
        dataInit.ajax({
            api: [[${apiPath.getCitys4resource}]],
            fn: supplyGetGxCity,
            params: {id: itemId}
        });
    });

    var latitude = 	'39.915177',longitude = '116.403887',venueAddress,model,roomLength;

    function showVenueDetail(data) {
        if(data && data.code == 0){
            model = data.data;
            var phone = model.telphone;
            var title = model.name;
            var area = model.deptid;
            var address = model.address;
            var type = model.type;
            var starttime=model.starttime;
            var endtime=model.endtime;
            var summary = model.actsummary;
            var description = model.hjqk;
            var imgPath = data.imgPath + dataInit.getBigImage(model.imgurl);
            //调分享接口
            dataInit.share(title,imgPath);
            $('#summary').html(summary);
            $('#description').html(description);
            $('#phone').text(phone);
            $('#address').text(address);
            $('#area').text(area);
            if(moment(starttime).format('YYYY-MM-DD')==moment(endtime).format('YYYY-MM-DD')){
                $('#times').text(moment(starttime).format('YYYY-MM-DD'));
            }else {
                $('#times').text(moment(starttime).format('YYYY-MM-DD')+' 至 '+moment(endtime).format('YYYY-MM-DD'));
            }
            $('#title,._title').text(title);
            $('#imgPath').attr('src',imgPath);
            crtuser = model.crtuser;
            _title = title;
            if(!(userid!=""&&crtuser!=""&&crtuser!=userid)){
                $(".go-next").hide();//信息发布者与申请配送者不能一致
            }
            /*var tag = model.etag.split(",");
            var tagHtml = "";
            for(var j in tag){
                tagHtml+='<span>'+tag[j]+'</span>';
            }
            $("#tag").html(tagHtml);*/
        }else {
            rongDialog.init({
                ico : 2, //1 勾  2 叉
                type : 1,
                desc : data.msg
            });
        }

    }

    function recommendList(data) {
        //推荐列表
        var tjvenlist = data.rows;
        $("#Recommend").empty();
        if(tjvenlist && tjvenlist.length){
            var i_length = tjvenlist.length>3 ? 3 : tjvenlist.length;
            for (var i=0;i<i_length;i++) {
                var imgPathT = data.imgPath + dataInit.getBigImage(tjvenlist[i].imgurl);
//                var endTime = moment(tjvenlist[i].statemdfdate).format('YYYY-MM-DD');
                if(tjvenlist[i].id != itemId){
                    $("#Recommend").append(
                        '<li>'+
                        '<div class="img">'+
                        '<a href="detail?id='+tjvenlist[i].id+'">'+
                        '<img src="'+imgPathT+'">'+
                        '</a>'+
                        '</div>'+
                        '<p>'+
                        '<a href="detail?id='+tjvenlist[i].id+'">'+tjvenlist[i].name+'</a>'+
                        '</p>'+
                        '</li>'
                    );
                }
            }
        }else {
            $("#Recommend").append('<div class="public-no-message-detail"></div>');
        }
    }
    function showTimeList(page,rows) {
        var params_page = page || 1;
        var params_rows = rows || 3;
        //page pageSize  cultid  type  styletype
        var params = {
            page: params_page,
            pageSize: params_rows,
            id: itemId
        }
        dataInit.ajax({
            api: [[${apiPath.supplyTimeList}]],
            fn: function (data) {
                timeList(data);
                dataInit.pageInit('artPagging', params_page, params_rows, data.total, showTimeList);
            },
            params: params
        });
    }
    function timeList(data) {
        if(data.code == 0 && data.rows.length>0){
            var _timeList = data.rows;
            if(_timeList.length<10 && data.total <10){
                $("#artPagging").hide();
            }
            $("#timeList").empty();
            var TimeListHtml = "";
            for (var i in _timeList) {
                var activeTime = moment(_timeList[i].timestart).format('YYYY-MM-DD HH:mm:ss');
                var endTime = moment(_timeList[i].timeend).format('YYYY-MM-DD HH:mm:ss');
                var j = parseInt(i) + 1;
                TimeListHtml += '<tr>' +
                    '<td class="not-conform">' + j + '</td>' +
                    '<td class="not-conform">' + activeTime + '</td>' +
                    '<td class="not-conform">' + endTime + '</td>' +
                    '</tr>';
            }
            $("#timeList").html(TimeListHtml);
        }else {
            rongDialog.init({
                ico : 2, //1 勾  2 叉
                type : 1,
                desc : data.msg
            });
        }
    }
    function supplyGetGxCity(data) {
        if( data.code == 0 && data.data){
            $("#range").html(data.data.city);
        }else {
            $("#rangeContent").hide();
        }
    }
</script>
</body>
</html>