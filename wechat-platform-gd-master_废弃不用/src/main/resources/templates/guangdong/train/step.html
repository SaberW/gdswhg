<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head th:include="guangdong/public/resource :: copy"></head>
<body>
<link rel="stylesheet" th:href="${basePath}+'/assets/css/public/detail.css'">
<link rel="stylesheet" th:href="${basePath}+'/assets/css/act/step.css'">
<link rel="stylesheet" th:href="${basePath}+'/assets/js/picker/css/mui.picker.css'">
<script th:src="${basePath}+'/assets/js/picker/js/mui.picker.min.js'" type="text/javascript"></script>
<div th:include="guangdong/public/leftBar :: copy"></div>
<div id="page">
    <div class="mui-content">
        <!-- Card Header -->
        <!-- Card Body -->
        <div class="mui-card no-corner">
            <div class="detail-header clearfix">
                <div class="img">
                    <a href="javascript:void(0)">
                        <img src="" class="lazy">
                    </a>
                </div>
                <div class="info">
                    <h2></h2>
                    <p></p>
                </div>
            </div>
        </div>
        <div class="mui-card no-corner step-table">
            <div class="mui-card-content mui-input-group">
                <div class="step-list mui-input-row">填写预订信息</div>
                <div class="mui-input-row input-merge">
                    <label>姓名</label>
                    <input id="username" type="text" maxlength="15" class="mui-input-clear" placeholder="请输入联系人姓名"
                           data-input-clear="1"><span
                        class="mui-icon mui-icon-clear mui-hidden"></span>
                </div>

                <!--<div class="mui-input-row">
                    <label>证件类型</label>
                    <div style="float: left">
                        <input name="idtype" type="radio" value="0"><span>身份证</span>
                        <input name="idtype" type="radio" value="1"><span>港澳台</span>
                    </div>
                </div>-->
                <div class="mui-input-row input-merge mui-table-view">
                    <label>证件类型</label>
                    <div class="mui-table-view-cell" id="idcardtype">
                        <div class="mui-pull-left" style="height: 35px;line-height: 35px"></div>
                    </div>
                </div>

                <div class="mui-input-row">
                    <label>身份证号</label>
                    <input id="usercode" type="text" minlength="18" maxlength="18" class="mui-input-clear" placeholder="请输入身份证号码"
                           data-input-clear="1"><span
                        class="mui-icon mui-icon-clear mui-hidden"></span>
                </div>
                <div class="mui-input-row">
                    <label>出生日期</label>
                    <input id="birthday" type="text" class="mui-input-clear"
                           data-input-clear="1" name="birthday" readonly><span
                        class="mui-icon mui-icon-clear mui-hidden"></span>
                </div>
                <div class="mui-input-row">
                    <label>手机号码</label>
                    <input id="txtMobile" type="tel" maxlength="11" class="mui-input-clear" placeholder="请输入联系电话"
                           data-input-clear="1"><span
                        class="mui-icon mui-icon-clear mui-hidden"></span>
                </div>
                <div class="mui-card-content-inner">
                    <div class="help-info">
                        <label><p><input id="readmeck" value="yes" type="checkbox" checked>&nbsp;&nbsp;我已阅读并接受<a
                                href="ydgz">《培训预订规则》</a>相关条款</p></label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <nav class="mui-bar mui-bar-tab">
        <div class="mui-tab-item"><a class="goNext" href="javascript:dealOrder()">下一步</a></div>
    </nav>
</div>
<script type="text/javascript" th:inline="javascript">
    var itemId = dataInit.getUrlParam('id');
    var userId = $('#temp_userId').val();
    var params = dataInit.getCache('train-step');
    var stepInfo = $.extend({},stepInfo,params);
    var idcardtype = $("#temp_idcardtype").val();
    var cardId = $("#temp_idCard").val();
    $().ready(function(){
        pageInit();
        mui('.mui-tab-item').on('tap','.goNext',function(){
            dealOrder();
        })
    })

    function initIdcardtypeItem(){
        mui(".mui-table-view").on('tap',"#idcardtype",function () {
            var picker = new mui.PopPicker();
            picker.setData([{value: 1, text: '中国大陆'}, {value: 2, text: '港澳台'}]);
            picker.show(function (selectItems) {
                idcardtype = selectItems[0].value;
                $('#idcardtype .mui-pull-left').text(selectItems[0].text);
                if (idcardtype && idcardtype=='2'){
                    $("input[name='birthday']").removeAttr("readonly");
                }else{
                    if (cardId && cardId.length>14){
                        $("#idCard").val(cardId);
                        var birthday =  birthdayInit(cardId);
                        $("input[name='birthday']").val(birthday);
                    }else{
                        $("input[name='birthday']").val('');
                        $("#usercode").val('');
                    }
                    $("input[name='birthday']").attr("readonly", 'readonly');
                }
            });
        })
    }

    function pageInit() {
        if (!params) {
            mui.toast("页面参数有误");
            return
        } else {
            $("#username").val($("#temp_nickName").val());
            $("#txtMobile").val($("#temp_mobile").val());
           // $("#usercode").val($("#temp_idCard").val());
           // $("input[name='birthday']").val(birthdayInit($("#usercode").val()));
            //----------------
            //身份证类型
            //initIdcardtypeItem();
            $('#idcardtype .mui-pull-left').text(idcardtype == '2'? '港澳台': '中国大陆');
            if(idcardtype == 2){
                //$('input[name="idtype"]').eq(1).attr("checked",true);
                $("#usercode").val($("#temp_idCard").val());
               // moment($("#temp_birthday").val()).format('YYYY-MM-DD');
                $("input[name='birthday']").val(moment($("#temp_birthday").val()).format('YYYY-MM-DD'));
            }else{
                //createBir();
                //$('input[name="idtype"]').eq(0).attr("checked",true);
                if(cardId){
                    var birthday =  birthdayInit(cardId);
                    $("input[name='birthday']").val(birthday);
                }
            }
            createBir();

            /*$('input[type=radio][name=idtype]').change(function() {
                if(this.value == 0){
                    $("#idCard").val(cardId);
                    $("#birthday").attr("readonly",true);
                    var birthday =  birthdayInit(cardId);
                    $("input[name='birthday']").val(birthday);
                    createBir();
                }else {
                    $("#birthday").attr("readonly",false);
                }

            });*/

            $("#usercode").val(cardId);

            //----------------

            $(".detail-header img").attr("src",params.img);
            $(".detail-header h2").text(params.title);
            $(".detail-header p").text(params.adr);
            mui('.help-info').on('tap', 'label', function () {
                if ($('#readmeck').is(':checked')) {
                    $('#readmeck').val('no');
                } else {
                    $('#readmeck').val('yes');
                }
            });

            //身份证如果有值，不能修改身份证，证件类型，出生日期
            var _usercode = $("#usercode").val();
            if (_usercode && _usercode!=''){
                $("#usercode").attr("readonly", 'readonly');
                $("#birthday").attr("readonly", 'readonly');
            }else{
                initIdcardtypeItem();
            }
            //手机号有值，不能修改
            var _mobile = $("#txtMobile").val();
            if (_mobile && _mobile!=''){
                $("#txtMobile").attr("readonly", 'readonly');
            }
            //$("#username")
            var _username = $("#username").val();
            if (_username && _username!=''){
                $("#username").attr("readonly", 'readonly');
            }
        }
    }

    //前端验证
    function verification() {
        var phone_reg = /^0?(13[0-9]|15[012356789]|17[013678]|18[0-9]|14[57])[0-9]{8}$/;
        var reg2 = /^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}([0-9]|X|x)$/;

       // var idcardtype = $('[name=idtype]:checked').val();
        var _value = ($("#usercode").val())
        //if (idcardtype == '1'){
        if (idcardtype == 2){
            /*var taiwanreg=/^[A-Z][0-9]{9}$/;
            var xianggangreg=/^[A-Z][0-9]{6}\([0-9A]\)$/;
            var aomenreg=/^[157][0-9]{6}\([0-9]\)$/;
            if(!taiwanreg.test(_value) && !xianggangreg.test(_value) && !aomenreg.test(_value)){
                mui.toast("请输入正确的身份证号码");
                return false;
            }*/
            if ($.trim(_value) == ''){
                mui.toast("请输入身份证号码");
                return false;
            }
        }else{
            var reg = /^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}([0-9]|X|x)$/;
            if(!reg.test(_value)){
                mui.toast("请输入正确的身份证号码");
                return false;
            }
        }
        var bir_reg = /^\d{4}-\d{2}-\d{2}$/;
        if(!bir_reg.test(($("#birthday").val()))){
            mui.toast("请输入正确的出生日期,例：2000-01-01");
            return false;
        }

        if ($("#username").val().length < 2 || $("#username").val().length > 15) {
            mui.toast("请输入正确的姓名");
            return false;
        }  else if ($('#birthday').val().length < 1) {
            mui.toast("出生日期不能为空");
            return false;
        } else if (!phone_reg.test(($("#txtMobile").val()))) {
            mui.toast("请输入正确的手机号码");
            return false;
        }  else if ($('#readmeck').val() == 'no') {
            mui.toast("请接受《培训预订规则》条款");
            return false;
        } else {
            return true;
        }
    }

    //判断是否可以报名
    function dealOrder(){
        if(verification()){
            dataInit.ajax({
                api:[[${apiPath.checkEnrol}]],
                params:{
                    userid:userId,
                    id:itemId
                },
                fn:nextPage
            })
        }
    }

    function nextPage(data) {
        if (data.code == 0) {
            var temp = {
                itemId:itemId,
                username:$("#username").val(),
                usercode:$("#usercode").val(),
                phone:$("#txtMobile").val(),
                birthday:$('#birthday').val()
            }
            stepInfo = $.extend({}, stepInfo, temp);
            dataInit.setCache('train-submit', stepInfo);
            window.location.href = 'stepconfirm';
        } else {
            mui.toast(data.msg || '正在操作此功能的用户众多，请稍后尝试');
        }
    }

    //生日自动生成
    function birthdayInit(idCard){
        var birthday = idCard;
        birthday = birthday.substring(6,14);
        birthday = birthday.substring(0,4)+"-"+birthday.substring(4,6)+"-"+birthday.substring(6);
        return birthday;
    }

    function createBir() {
        $("#usercode").keyup(function(){
            if (idcardtype == 2){
                return;
            }
            var idCard = $(this).val();
            var birthday = birthdayInit(idCard);
            $("input[name='birthday']").val(birthday);
        })

        $("#usercode").focusout(function(){
            if (idcardtype == 2){
                return;
            }
            var idCard = $(this).val();
            var birthday = birthdayInit(idCard);
            $("input[name='birthday']").val(birthday);
        })
    }
</script>
</body>
</html>