<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head th:include="guangdong/public/resource :: copy"></head>
<body>
<link rel="stylesheet" th:href="${basePath}+'/assets/css/venue/stepconfirm.css'" >
<link rel="stylesheet" th:href="${basePath}+'/assets/css/public/detail.css'" >
<div th:include="guangdong/public/leftBar :: copy"></div>
<div id="page">
    <div class="mui-content" id="modelHtml">
        <!-- Menu Body Begin -->

        <!-- Menu Body End -->
    </div>
    <nav class="mui-bar mui-bar-tab">
        <div class="mui-tab-item"><a class="goNext" href="javascript:void(0)">确认订单</a></div>
    </nav>
</div>
<script type="text/javascript" th:inline="javascript">
    var userId = $("#temp_userId").val();
    var hint = dataInit.getCache('hint');
    var params = dataInit.getCache('train-submit'),flag = true;

    $().ready(function(){
        pageInit();
        mui('.mui-tab-item').on('tap','.goNext',function(){
            confirmOrder();
        })
    })
    function pageInit(){
        var  adr_cls;
        if(params.adr == undefined){
            adr_cls = "none"
        }
        html = '<div class="mui-card no-corner">\
                  <div class="mui-card-header wrapper-par">\
                     <div class="left-wrapper">\
                       <img class="lazy" id="pageImg" src="'+params.img+'">\
                     </div>\
                     <div class="right-wrapper">\
                        <div class="page-title">'+params.title+'</div>\
                     </div>\
                  </div>\
                </div>\
                <div class="mui-card no-corner label-list">\
                    <ul class="mui-table-view mui-table-view-chevron">\
                        <li class="mui-table-view-cell mui-media '+adr_cls+'">\
                            <a href="javascript:void(0)">\
                                <div class="mui-media-body label">培训地址</div>\
                                <div id="title" class="detail">'+params.adr+'</div>\
                            </a>\
                        </li>\
                        <li class="mui-table-view-cell mui-media">\
                            <a href="javascript:void(0)">\
                                <div class="mui-media-body label">培训周期</div>\
                                <div class="detail">'+params.applyTime+'</div>\
                            </a>\
                        </li>\
                        <li class="mui-table-view-cell mui-media">\
                            <a href="javascript:void(0)">\
                                <div class="mui-media-body label">报名周期</div>\
                                <div class="detail">'+params.trainTime+'</div>\
                            </a>\
                        </li>\
                        <li class="mui-table-view-cell mui-media">\
                            <a href="javascript:void(0)">\
                                <div class="mui-media-body label">出生日期</div>\
                                <div class="detail">'+params.birthday+'</div>\
                            </a>\
                        </li>\
                        <li class="mui-table-view-cell mui-media">\
                            <a href="javascript:void(0)">\
                                <div class="mui-media-body label">手机号码</div>\
                                <div class="detail">'+params.phone+'</div>\
                            </a>\
                        </li>\
                        <li class="mui-table-view-cell mui-media">\
                            <a href="javascript:void(0)">\
                                <div class="mui-media-body label">身份证号</div>\
                                <div class="detail">'+params.usercode+'</div>\
                            </a>\
                        </li>\
                    </ul>\
                </div>';
        $('#modelHtml').html(html);
    }

    //验证是否可预订
    function confirmOrder() {
        if(flag){
            flag = false;
            dataInit.ajax({
                api:[[${apiPath.checkEnrol}]],
                params:{
                    userid: userId,
                    id: params.itemId
                },
                fn:nextPage
            })
        }
    }
    //开始下单
    function nextPage(data) {
        if(data.code == 0 ){
            var temp_params = {
                name : params.username,
                idCard : params.usercode,
                birthday : params.birthday,
                mobile:params.phone,
                userid : userId,
                traid : params.itemId
            }
            dataInit.ajax({
                api: [[${apiPath.enrol}]],
                params: temp_params,
                fn: function (data) {
                    if(data.code == 0){
                        var completeMsg = {
                            'modelName':'返回培训首页',
                            'url' : 'train/index',
                            'title': '恭喜您，您已申请预订'+params.title+'，请等待工作人员的确认！',
                            'msg': '如需退订，请至“个人中心-我的培训”进行退订'
                        }
                        dataInit.setCache('completeMsg', completeMsg);
                        window.location.href = '../complete';

                    }else {
                        flag = true;
                        mui.toast(data.msg || '预订失败');
                    }
                },
            });
        }else {
            flag = true;
            mui.toast(data.msg || '预订失败');
        }
    }
</script>
</body>
</html>