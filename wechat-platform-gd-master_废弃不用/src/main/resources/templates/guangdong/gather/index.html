<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head th:include="guangdong/public/resource :: copy"></head>
<body>
<link rel="stylesheet" th:href="${basePath}+'/assets/css/gather/gather.css'" >
<link rel="stylesheet" th:href="${basePath}+'/assets/css/index/index.css'" >
<div th:include="guangdong/public/leftBar :: copy"></div>
<div id="page">
    <div class="mui-content">
        <div class="index-header" style="min-height: 60px; margin-bottom: 0;">
            <div class="search-area-user mui-clearfix">
                <a href="../changecity"><div class="area" id="index_area"><i class="iconfont icon-jiantou"></i></div></a>
                <div class="search"><i class="iconfont icon-search"></i><a href="../search">搜点什么...</a></div>
                <a href="../usercenter/index">
                    <div class="user" th:if="${session.sessUserKey == null}">
                        <img th:src="${basePath}+'/assets/img/public/face2.png'" alt="个人头像">
                    </div>
                    <div class="user"  th:if="${session.sessUserKey != null}">
                        <img th:src="${session.sessUserKey.headimgurl} ? ${session.sessUserKey.headimgurl} : ${basePath}+'/assets/img/public/face2.png'" alt="个人头像">
                        <em class="message-wx-2"></em>
                    </div>
                </a>
            </div>
        </div>
        <!--轮播图-->
        <div class="carousel">
            <div class="swiper-container minor-slider" id="slider-head">
                <div class="swiper-wrapper" id="slider">
                </div>
                <div class="swiper-pagination minor-slider-pagination"></div>
            </div>
        </div>
        <!--轮播图-->
        <!--文化众筹-->
        <div class="culture">
            <div class="culture-nav mui-clearfix">
                <ul>
                    <li>
                        <img th:src="${basePath}+'/assets/img/public/project@2x.png'">
                        <h3>众筹项目</h3>
                        <a th:href="${basePath}+'/gather/list'"></a>
                    </li>
                    <li>
                        <img th:src="${basePath}+'/assets/img/public/brand@2x.png'">
                        <h3>众筹品牌</h3>
                        <a th:href="${basePath}+'/gather/brand'"></a>
                    </li>
                    <li>
                        <img th:src="${basePath}+'/assets/img/public/email@2x.png'">
                        <h3>众筹资讯</h3>
                        <a th:href="${basePath}+'/gather/news'"></a>
                    </li>
                    <li>
                        <img th:src="${basePath}+'/assets/img/public/zhengcefagui@2x.png'">
                        <h3>法律法规</h3>
                        <a th:href="${basePath}+'/gather/fagui'"></a>
                    </li>
                </ul>
            </div>
        </div>
        <!--文化众筹-->

        <div class="culture-list">
            <div class="culture-title">
                <img th:src="${basePath}+'/assets/img/public/title-tuijian@2x.png'">
            </div>
            <ul id="model-list"></ul>
        </div>
    </div>
</div>
<script type="text/javascript" th:inline="javascript">

    $().ready(function () {
        showSlider();
        dataInit.ajax({
            api: [[${apiPath.zcProjectList}]],
            fn: projectList,
            params: {
                page: 1,
                pageSize: 12,
                cultid: $.cookie('cultid')
            }
        });
        //显示城市
        showCity();
    });

    function showCity() {
        var coocity = '';
        var cultType = $.cookie('cultType');
        if(typeof cultType != "undefined"){
            var siteName = $.cookie('siteName');
            coocity = siteName;
        }else{
            coocity = '全省站';
        }
        $("#index_area").html(coocity+'<i class="iconfont icon-jiantou">');
    }

    function showSlider() {
        dataInit.ajax({
            api: [[${apiPath.showAdver}]],
            params: {
                type: 8,
                city: $.cookie('city'),
                cultid: $.cookie('cultid')
            },
            fn: function (data){
                if( data.code == 0 && data.rows.length > 0){
                    var html = '';
                    for(var i in data.rows){
                        var model = data.rows[i];
                        var ModelUrl = model.url?model.url:'javascript:void(0)';
                        var img = data.imgPath + dataInit.getBigImage(model.picture);
                        html += '    <div class="swiper-slide">' +
                            ' <a href="'+ModelUrl+'"><img class="lazy" src="' +img+ '"></a>' +
                            '    </div>';
                    }
                    $("#slider").html(html);
                }else {
                    //mui.toast(data.msg || '数据加载失败')
                    var imgPath = [[${basePath}]] + '/assets/img/public/dance.jpg';
                    $("#slider").html('    <div class="swiper-slide">' +
                        ' <a href="javascript:void(0)"><img class="lazy" src="' +imgPath+ '" alt=""></a>' +
                        '    </div>');
                }
                var mySwiper = new Swiper ('#slider-head',{
                    loop: true,
                    autoplay: 5000,
                    pagination: {
                        el: '.swiper-pagination'
                    }
                })
            }
        });
    }
    function projectList(data) {
        $("#model-list").html('');
        var html = "";
        var __success = '众筹成功';
        var __fail = '众筹失败';
        var __underway = '众筹中';
        var dataNow = data.data.now;
        if (data.code == 0 && data.rows.length > 0) {
            for (var i in data.rows) {
                var model = data.rows[i];
                var img = data.imgPath + dataInit.getBigImage(model.imgurl);
                //判断众筹状态
                var isOverdueSize = isOverdue(model.issuccess,model.timestart,model.timeend,dataNow);
                var _zcState = '';
                switch (isOverdueSize){
                    case 0:
                        _zcState = __fail;
                        break;
                    case 1:
                        _zcState = __success;
                        break;
                    case 2:
                        _zcState = __underway;
                        break;
                    case 3:
                        _zcState = __underway;
                        break;
                }
                //获得众筹达成率
                var _DCl = parseInt((model.orderCount/model.nummin)*100);
                _DCl = _DCl>100?100:_DCl;
                //获得众筹剩余份数
                var _ZC_Max = model.numsum - model.orderCount;
                _ZC_Max = _ZC_Max<0 ? 0 : _ZC_Max;
                //获取剩余天数
                var SY_Days = getDays(model.timeend,dataNow,model.timestart);
                //判断众筹分类：4活动，5培训，0其他
                var _href_detail = '',label = '';
                if(model.etype == 4){
                    _href_detail = 'actdetail?id='+model.id;
                    label = '活动众筹';
                }else if(model.etype == 5) {
                    _href_detail = 'traindetail?id='+model.id;
                    label = '培训众筹';
                }else if(model.etype == 0){
                    _href_detail = 'otherdetail?id='+model.id;
                    label = '其他众筹';
                }else {
                    _href_detail = 'otherdetail?id='+model.id;
                    label = '其他众筹';
                }
                html += '<li><a href="'+_href_detail+'">'+
                    '<div class="img">'+
                    '<img class="lazy" src="'+img+'">'+
                    '<div class="gather-title">'+
                    '<h2><span class="label">'+label+'</span>'+model.title+'</h2>'+
                    '</div></div><div class="gather-info">'+
                    '<div class="gather-state">'+
                    '<div class="zc-state">'+_zcState+'</div>'+
                    '<span>'+model.numsum+'份</span>'+
                    '</div><div class="gather-progress-bar">'+
                    '<span style="width: '+_DCl+'%;"></span>'+
                    '</div><div class="progress-table mui-clearfix">'+
                    '<div class="progress-table-list">'+
                    '<span>'+SY_Days+'</span>'+
                    '</div><div class="progress-table-list">'+
                    '<span>剩余'+_ZC_Max+'份</span>'+
                    '</div><div class="progress-table-list">'+
                    '<span>完成'+_DCl+'%</span></div></div></div></a></li>';
            }
        } else {
            html = '<div class="newbility-no-msg"></div>';
        }
        $("#model-list").html(html);
    }


    //判断众筹是否过期
    function isOverdue(issuccess,timestart,timeend,dataNow) {
        if(dataNow>timeend && issuccess != 1 ){
            if(issuccess == 0){
                return 3;//其他状态
            }else {
                return 0;//已结束
            }
        }else if(dataNow<timeend && dataNow>timestart && issuccess !=1){
            return 2;//众筹中
        }else if(issuccess == 1) {
            return 1;//已成功
        }else {
            return 3;//其他状态
        }
    }

    //获取剩余天数
    function getDays(timeend,_dataNow,timestart) {
        if(_dataNow>timeend){
            return '已结束';
        }else if(_dataNow>timestart){
            return '剩余 '+moment(timeend).fromNow(true);
        }else {
            return '未开始';
        }
    }
</script>
</body>
</html>