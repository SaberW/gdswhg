<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head th:include="guangdong/public/resource :: copy"></head>
<link th:href="${basePath}+'/assets/style/normalize.css'" rel="stylesheet">
<link th:href="${basePath}+'/assets/style/gdqw.css'" rel="stylesheet">

<script th:src="${basePath}+'/assets/js/layer/layer.js'" type="text/javascript"></script>

<body>
<div class="qwMain">
    <!--公共主头部开始-->
    <div id="header" th:include="guangdong/public/header :: copy"></div>
    <!--公共主头部结束-->
    <div class="qwHeadSou">
        <!--<div class="filterWrap clearfix" id="lib_type" style="width: 960px">
            <ul class="filterListYi clearfix">
                <li class="item cur" data-value="">全部</li>
            </ul>
        </div>-->
        <div class="filterSearWrap clearfix" style="margin-top: 0;">
            <!--<div class="selBox">
                <div class="selOne">
                    <span>资源库</span>
                </div>
                <div class="selTwo" style="display: none">
                    <a class="sItem cur" data-value="1" href="javascript:;">资源库</a>
                    <a class="sItem" id="zy" data-value="2" href="javascript:;">资源</a>
                </div>
            </div>-->
            <input class="txtInp" type="text" id="searchKey" placeholder="请输入关键字">
            <div class="fsBtn"><img th:src="${basePath}+'/assets/image/search1.png'">库内搜索</div>
        </div>
    </div>
    <div class="qwContent">
        <div class="breadCrumbs jz1200">
            <a th:href="${basePath}+'/index'">首页</a>&nbsp;&nbsp;&gt;&nbsp;&nbsp;
            <a th:href="${basePath}+'/qwzy/list?arttype='+${arttype}+'&masstype=1&libid='+${libid}+'&resourcetype='+${resourcetype}+'&srchkey='+${srchkey}">资源库搜索列表&nbsp;&nbsp;&gt;&nbsp;&nbsp;</a>
            <a id="libname">
            </a>
        </div>
        <div class="filterGray">
            <div class="filterWrap clearfix">
                <div class="lab">艺术类型：</div>
                <div class="filterRight" id="art_type">
                    <ul class="filterListEr clearfix">
                        <li class="item all cur" data-value="">全部</li>
                    </ul>
                </div>
            </div>
        </div>
       <!-- <ul class="qwPicCharList">

        </ul>

        <div class="qwPicList">
            <ul class="clearfix" id="mass_list">
            </ul>
        </div>
-->
        <div id="mass_list" style="display: block">
            <div class="qwTabTou clearfix">
                <div class="wen searchCount">

                </div>
                <div class="selPage">
                    <div class="wzOne">每页显示<span>20</span>条</div>
                    <div class="wzTwo" style="display: none;">
                        <div class="item"><span>20</span></div>
                        <div class="item"><span>50</span></div>
                        <div class="item"><span>100</span></div>
                    </div>
                </div>
                <script type="text/javascript">
                    function setStopPropagation(evt) {
                        var e = evt || window.event;
                        if(typeof e.stopPropagation == 'function') {
                            e.stopPropagation();
                        } else {
                            e.cancelBubble = true;
                        }
                    }
                    $('.selPage').on('click', '.wzOne', function () {
                        $(this).siblings('.wzTwo').toggle();
                    });
                    $('.selPage .wzTwo').on('click', '.item', function () {
                        $(this).parent().siblings('.wzOne').find('span').html($(this).find('span').html());
                        $(this).parent().hide();
                        loadData()
                    });
                    $('.selPage').on('click', function (evt) {
                        setStopPropagation(evt);
                    });
                    $('html, body').on('click', function () {
                        $('.selPage .wzTwo').hide();
                    });
                </script>
            </div>
            <div class="qwTabListWc">
                <table class="qwTabList">
                    <colgroup width="110"></colgroup>
                    <colgroup width="180"></colgroup>
                    <colgroup width="110"></colgroup>
                    <colgroup width="180"></colgroup>
                    <colgroup width="110"></colgroup>
                    <colgroup width="110"></colgroup>
                    <colgroup width="180"></colgroup>
                    <colgroup width="110"></colgroup>
                    <colgroup width="110"></colgroup>
                    <thead><tr>
                        <th>序号</th>
                        <th>资源名称</th>
                        <th>作者</th>
                        <th>所属文化馆</th>
                        <th>类型</th>
                        <th>访问权限</th>
                        <th>发布时间</th>
                        <th>浏览量</th>
                        <th>下载量</th>
                    </tr>
                    </thead>
                    <tbody id="mass_list_body">

                    </tbody>
                </table>
            </div>
        </div>


        <!--分页开始 -->
        <div class="green-black" id="artPagging" style="margin-bottom: 40px;margin-top:60px;"></div>
        <!--分页结束-->
    </div>
    <!--底部开始-->
    <div th:include="guangdong/public/footer :: copy"></div>
    <!--底部结束-->
</div>



<script type="text/javascript" th:inline="javascript">
    var basePath = [[${basePath}]];
    $('#libname').html([[${libname}]])

    //1：资源库  2：资源
    var masstype = dataInit.getUrlParam('masstype') || "";
    /** 加载数据 */
    function loadData(page,rows) {
        var params_page = page || 1;
        var rows = $(".wzOne span").html();
        var params_rows = rows || dataInit.getUrlParam('pageSize') || rows;
        //if(resclazz) params['libid'] = resclazz;
        var params = {};
        params['page'] = params_page;
        params['pageSize'] = params_rows;
        params['cultid'] = $.cookie('cultid');
        params['token'] = token;
        params['timestamp'] = timestamp;
        if(masstype==2){
            $("#zy").parent().siblings('.selOne').find('span').html('资源');
            $("#zy").addClass('cur').siblings().removeClass('cur');
        }

        var srchkey = $('#searchKey').val();
        var restype = $('.filterListYi .cur').attr('data-value');
        var arttype = $('.filterListEr .cur').attr('data-value');
        var resclazz =  dataInit.getUrlParam('libid') ;
        var params = {};
        if(srchkey) params['srchkey'] = srchkey;
        if(restype) params['restype'] = restype;
        if(resclazz) params['libid'] = resclazz;
        params['page'] = params_page;
        params['pageSize'] = params_rows;
        params['cultid'] = $.cookie('cultid');
        params['userid'] = [[${session.qw_sessUserKey.userId}]];// 当前用户ID
        if(arttype) params['arttype'] = arttype;
        params['token'] = token;
        params['timestamp'] = timestamp;
        //加载资源数据
        console.log("加载资源数据")
        //加载数据
        dataInit.ajax({
            api: [[${apiPath.massResList}]],
            params: params,
            fn: function(data){
                afterLoadDataShowData(data);
                dataInit.pageInit('artPagging', params_page, params_rows, data.total, loadData);
            }
        })

    }

    /** 加载数据之后显示数据 */
    function afterLoadDataShowData(data){
        var UL = $(".qwPicCharList");
        UL.empty();
        var UL1 = $("#mass_list_body");
        UL1.empty();
        if(masstype==1){
            if(data){
                var li_html = '';
                if($.isArray(data.rows) && data.rows.length > 0){
                    for(var i=0; i<data.rows.length; i++){
                        var row = data.rows[i];
                        var respicture = dataInit.getMidImage(row.imgurl);//图片地址
                        var name = row.name;//资源名称
                        var imgUrl = data.imgPath + respicture;
                        var memo = row.memo;
                        var tagids = row.tags;

                    li_html +='<li class="clearfix" onclick="doDetail(\''+row.id+'\')">\n' +
                        '                        <div class="pic"><img src="'+imgUrl+'"></div>\n' +
                        '                        <div class="char">\n' +
                        '                        <div class="tit">'+name+'</div>\n' +
                        '                        <div class="wen">简介：'+memo+'</div>\n' +
                        '                    <div class="tag" tag-value="'+tagids+'"></div>\n' +
                        '                        <div class="liu">浏览量：</div>\n' +
                        '                    </div>\n' +
                        '                    </li>';

                    }
                    UL.append(li_html);
                }else{
                    UL.append("<div class='public-no-message'></div>");
                }
                getTags();
            }
        }else{
            if(data){
                var li_html = '';
                if($.isArray(data.rows) && data.rows.length > 0){
                    for(var i=0; i<data.rows.length; i++){
                        var row = data.rows[i];
                        var restype = row.resourcetype;
                        var libid = row.libid;
                        var resid = row.resid;
                        var respicture = dataInit.getMidImage(row.respicture);//图片地址
                        var resname = row.resname;//资源名称
                        var libname = row.name;//资源名称
                        var icon = '';//显示音频还是视频的图片
                        var download = '';//下载图标
                        var publishtime = timeStamp2String(row.publishtime);

                        var resauthor = row.resauthor?row.resauthor:'';
                        var auth = "无";
                        if(row.authority){
                            auth = "有";
                        }

                        if(restype == 'audio'){
                            restype = '音频';
                            icon = '<i class="icon iconfont icon-yinpin"></i>';
                            respicture = [[${basePath}]]+'/assets/img/public/audio.png';//音频图片
                        }else if(restype == 'video'){
                            icon = '<i class="icon iconfont icon-CombinedShape"></i>';
                            restype = '视频';
                        }else if(restype == 'img'){
                            restype = '图片';
                        }else{
                            download = '<div class="download">下载<i class="icon iconfont icon-download-copy"></i></div>';
                            //respicture = [[${basePath}]]+'/assets/img/public/file.png';//文档图片
                            respicture = [[${basePath}]] + dataInit.getFileTypeIcon(row.resurl, '/assets/img/brand/xiazai.jpg');
                            restype = '文档';
                        }

                        li_html +='<tr style="cursor: pointer" resid="'+resid+'" libid="'+libid+'" onclick="doResDetail(\''+libid+'\',\''+resid+'\');" target="">\n' +
                            '                        <td>'+parseInt(i+1)+'</td>\n' +
                            '                        <td>'+resname+'</td>\n' +
                            '                        <td>'+resauthor+'</td>\n' +
                            '                        <td>'+libname+'</td>\n' +
                            '                        <td>'+restype+'</td>\n' +
                            '                        <td class="purview">'+auth+'</td>\n' +
                            '                        <td>'+publishtime+'</td>\n' +
                            '                        <td class="liu">0</td>\n' +
                            '                        <td class="xia">0</td>\n' +
                            '                    </tr>';
                    }
                    UL1.append(li_html);
                    var search_div = '找到<span id="mass_count">'+data.total+'</span>条结果';

                  /*  if(data.data.imgCount>0){
                        search_div+='图片资源<span>'+data.data.imgCount+'</span>条';
                    }
                    if(data.data.videoCount>0){
                        search_div+='视频资源<span>'+data.data.videoCount+'</span>条';
                    }
                    if(data.data.audioCount>0){
                        search_div+='音频资源<span>'+data.data.audioCount+'</span>条';
                    }
                    if(data.data.fileCount>0){
                        search_div+='文档资源<span>'+data.data.fileCount+'</span>条';
                    }*/
                    $(".searchCount").html(search_div);
                    getResInfo()
                }else{
                    UL1.append("<tr><td colspan='9'><div class='public-no-message'></div></td></tr>");
                    var search_div = '找到<span id="mass_count">'+data.total+'</span>条结果';
                    $(".searchCount").html(search_div);
                }
            }
        }

    }


    function getResInfo(){
        var userid = [[${session.qw_sessUserKey.userId}]];// 当前用户ID
        $("#mass_list_body tr").each(function () {
            var libid = $(this).attr('libid');
            var resid = $(this).attr('resid');
            var UL = $(this);
            $.ajax({
                url : [[${apiPath.getInfoByResId}]],
                method : "POST",
                data : {libid:libid,resid:resid,userid:userid,massType:2,token:token,timestamp:timestamp},
                cache: false,
                dataType:'json',
            }).success(function(data) {
                var info = data.data;
                $(UL).find(".liu").html(info.viewCount);
                $(UL).find(".xia").html(info.downcount);
                console.log(info);
            });
        })
    }


    function getTags(){
        $(".tag").each(function () {
            var tagids = $(this).attr('tag-value');
            if(!tagids) return "";
            var UL = $(this);
            $.ajax({
                url : [[${apiPath.tags}]],
                method : "POST",
                data : {type: 56, cultid: $.cookie('cultid'),tags:tagids,token:token,timestamp:timestamp},
                cache: false,
                dataType:'json',
            }).success(function(data) {
                var li_html = "";
                if($.isArray(data.rows)){
                    for(var i=0; i<data.rows.length; i++){
                        var _tag = data.rows[i];
                        var _tag_name = _tag.name;
                        li_html+='<span>'+_tag_name+'</span>';
                    }
                }
                UL.html(li_html);
            });

        })

    }


    function doResDetail(libid,resid) {
        var href = basePath+'/qwzy/detail?libid='+libid+'&resid='+resid;
        var srchkey = $('#searchKey').val();
        var restype = $('.filterListYi .cur').attr('data-value');
        var arttype = $('.filterListEr .cur').attr('data-value');

        if(restype) href += '&resourcetype='+restype;
        if(srchkey) href += '&srchkey='+srchkey;
        if(arttype) href += '&arttype='+arttype;

        window.location.href= href;
    }

    function doDetail(libid) {
        var href = basePath+'/qwzy/detail?libid='+libid+'&resid='+resid;
        var srchkey = $('#searchKey').val();
        var restype = $('.filterListYi .cur').attr('data-value');
        var arttype = $('.filterListEr .cur').attr('data-value');

        if(restype) href += '&resourcetype='+restype;
        if(srchkey) href += '&srchkey='+srchkey;
        if(arttype) href += '&arttype='+arttype;

        window.location.href= href;
    }

    /** 切换资源分类 */
    function conditionChange(ele) {
        var spanEle = $(ele).parent('span');
        var parentid = spanEle.parent('div').attr('id');
        if(parentid == 'condition_1'){//切换资源分类
            var _restype = spanEle.attr('restype');
            $('#condition_1 span[restype="'+_restype+'"]').addClass("active").siblings().removeClass("active");
            if(_restype != ''){
                $('#condition_2 span[restype!="'+_restype+'"]').hide();
                $('#condition_2 span[restype="'+_restype+'"]').show();
            }else{
                $('#condition_2 span').show();
            }

            $('#condition_2 span:first').show();
            $('#condition_2 span:first').addClass("active").siblings().removeClass("active");
            //加载数据
            loadData();
        }else{//切换子分类
            spanEle.addClass("active").siblings().removeClass("active");
            //加载数据
            loadData();
        }
    }

    /** 加载分类 */
    function init_load_type() {
        var cultid = $.cookie('cultid') || '';
        dataInit.ajax({
            api: [[${apiPath.massResType}]],
            params:{"cultid": cultid,token:token,timestamp:timestamp},
            fn:function(data){
                if($.isArray(data)){
                    var html_item = '';
                    var html_item_child = '';
                    for(var i=0; i<data.length; i++){
                        var _type = data[i];
                        var _type_name = _type.name;
                        var _type_value = _type.value;
                        var _type_child = _type.child;


                        if($.isArray(_type_child) && _type_child.length > 0){
                            for(var j=0; j<_type_child.length; j++){
                                html_item_child += '<span class="item" resclazz="'+_type_child[j].id+'" restype="'+_type_value+'"><a href="javascript:void(0)" onclick="conditionChange(this)">'+_type_child[j].name+'</a></span>';
                            }
                        }

                        html_item += '<span class="item" restype="'+_type_value+'"><a href="javascript:void(0)" onclick="conditionChange(this)">'+_type_name+'</a></span>';
                    }
                    $('#condition_1').append(html_item);
                    $('#condition_2').append(html_item_child);

                    //显示分类和搜索框值
                    init_show_type();
                    //加载数据
                    loadData();
                }
            }
        });
    }

    // 初始化
    function initAuth() {
        var libid = [[${libid}]];//资源库标识
        var userid = [[${session.qw_sessUserKey.userId}]];// 当前用户ID
        dataInit.ajax({
            api: [[${apiPath.getMassUserAuth}]],
            params:{libid: libid, userid: userid,token:token,timestamp:timestamp},
            fn:function(data){
                var auth = data.data.authority;
                if(auth != null && auth != "" && auth.indexOf("view") >= 0){
                    //判断资源库是否启用
                    loadMassLibDetail(libid);
                }else{
                    noAuth();
                    setTimeout(function(){
                        window.location.href = basePath + '/qwzy/index';
                    }, 2000);
                }
            }
        });
    }

    function loadMassLibDetail(libid){
        dataInit.ajax({
            api: [[${apiPath.info}]],
            params:{id: libid,token:token,timestamp:timestamp},
            fn:function(data){
                var info = data.data;
                if(info.state == 1){

                    loadType();

                    loadData();

                    loadYsType();

                    addVisit();
                }else{
                    noAuth('资源库未启用');
                    setTimeout(function(){
                        window.location.href = basePath + '/qwzy/index';
                    }, 2000);
                }
            }
        });
    }

    //加载分类
    function loadType() {
        dataInit.ajax({
            api: [[${apiPath.massResType}]],
            params:{"cultid": cultid,token:token,timestamp:timestamp},
            fn:function(data){
                if($.isArray(data)){
                    var li_html = '';
                    for(var i=0; i<data.length; i++){
                        var _type = data[i];
                        var _type_name = _type.name;
                        var _type_value = _type.value;

                        li_html+='<li class="item" id="'+_type_value+'" data-value="'+_type_value+'">'+_type_name+'</li>';
                    }
                    $('#lib_type ul').append(li_html);
                }
                //类型
                var resourcetype = dataInit.getUrlParam('resourcetype') || "";
                if(resourcetype){
                    $("#"+resourcetype).addClass('cur').siblings().removeClass('cur');
                }
                //加载数据
                //loadData();
            }
        });
    }

    //加载艺术分类
    function loadYsType() {
        dataInit.ajax({
            api: [[${apiPath.getTypes}]],
            params:{"cultid": cultid,type:1,token:token,timestamp:timestamp},
            fn:function(data){
                if($.isArray(data.rows)){
                    var li_html = '';
                    for(var i=0; i<data.rows.length; i++){
                        var _type = data.rows[i];
                        var _type_name = _type.name;
                        var _type_id = _type.id;
                        li_html+='<li class="item" data-value="'+_type_id+'">'+_type_name+'</li>';
                    }
                    $('#art_type ul').append(li_html);
                }
            }
        });
    }

    //增加浏览量
    function addVisit() {
        dataInit.ajax({
            api: [[${apiPath.addVisit}]],
            params:{resid: dataInit.getUrlParam('libid'),token:token,timestamp:timestamp},
            fn:function(data){
                console.log(data);
            }
        });
    }

    $(function () {

        //关键字
        var srchkey = [[${srchkey}]];

        /*if(srchkey){
            $('#searchKey').val(srchkey);
        }*/


        // 初始化权限
        initAuth();

        //搜索
        $('.fsBtn').on('click',function(){
            var srchkey = $('#searchKey').val();
            $(".all").addClass("cur").siblings().removeClass("cur");
            loadData();
        });

        //回车事件
        $("body").keydown(function(e) {
            var isFocus = $('#searchKey').is(":focus");
            var srchkey = $('#searchKey').val();


            click(e);

            var curKey = e.which;
            if(curKey == "13" && isFocus){
                loadData();
            }
/*
            if (event.keyCode == "13" && isFocus) {
                loadData();
            }*/
        });
    });

    function noAuth(content) {
        if(!content) content = '无查看权限！';
        var quanxian = '<div style="padding-top: 45px">' +
            '<img style="display: block;margin: 0 auto;margin-bottom: 30px;" src="'+basePath+'/assets/image/quanxian.png">' +
            '<p style="font-size: 24px;color: #333;text-align: center">'+content+'</p>' +
            '</div>'
        layer.open({
            type: 1,
            title: '',
            shadeClose: true,
            shade: 0.6,
            area: ['360px', '320px'],
            resize: false,
            skin: 'layui-layer-purview',
            content: quanxian
        });
    }
    function setStopPropagation(evt) {
        var e = evt || window.event;
        if(typeof e.stopPropagation == 'function') {
            e.stopPropagation();
        } else {
            e.cancelBubble = true;
        }
    }
    $(function () {
        $('.filterListYi').on('click', '.item', function () {
            $(this).addClass('cur').siblings().removeClass('cur');
        });

        $('.filterListEr').on('click', '.item', function () {
            $(this).addClass('cur').siblings().removeClass('cur');
            loadData();
        });

        $('.selBox .selOne').on('click', function () {
            $(this).siblings('.selTwo').toggle();
        });
        $('html,body').click(function () {
            $('.selBox .selTwo').hide();
        });
        $('.selBox').click(function (evt) {
            setStopPropagation(evt)
        });
        $('.selBox .selTwo').on('click', '.sItem', function () {
            $(this).parent().hide();
            $(this).parent().siblings('.selOne').find('span').html($(this).html());
            $(this).addClass('cur').siblings().removeClass('cur');
            masstype = $(this).attr("data-value");
        });
    });

    function click(e) {
        if (document.all) {
            if (event.button==2||event.button==3) { console.log("谢谢您的合作！");
                oncontextmenu='return false';
            }
        }
        if (document.layers) {
            if (e.which == 3) {
                oncontextmenu='return false';
            }
        }
    }
    if (document.layers) {
        document.captureEvents(Event.MOUSEDOWN);
    }
    document.onmousedown=click;
    document.oncontextmenu = new Function("return false;")
    document.onkeydown =document.onkeyup = document.onkeypress=function(){
        if(window.event.keyCode == 123) {
            window.event.returnValue=false;
            return(false);
        }
    }


    //在Jquery里格式化Date日期时间数据
    function timeStamp2String(time) {
        var datetime = new Date();
        datetime.setTime(time);
        var year = datetime.getFullYear();
        var month = datetime.getMonth() + 1 < 10 ? "0" + (datetime.getMonth() + 1) : datetime.getMonth() + 1;
        var date = datetime.getDate() < 10 ? "0" + datetime.getDate() : datetime.getDate();
        var hour = datetime.getHours() < 10 ? "0" + datetime.getHours() : datetime.getHours();
        var minute = datetime.getMinutes() < 10 ? "0" + datetime.getMinutes() : datetime.getMinutes();
        var second = datetime.getSeconds() < 10 ? "0" + datetime.getSeconds() : datetime.getSeconds();
        return year + "-" + month + "-" + date + " " + hour + ":" + minute + ":" + second;
    }


</script>
</body>
</html>