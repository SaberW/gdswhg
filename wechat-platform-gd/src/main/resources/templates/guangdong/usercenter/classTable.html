<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head th:include="guangdong/public/resource :: copy"></head>
<body>
<link rel="stylesheet" th:href="${basePath}+'/assets/css/usercenter/usercenter.css'">
<div th:include="guangdong/public/leftBar :: copy"></div>
<div id="page">
    <div class="mui-content">
        <!-- 课程表-->
        <div class="t_course">
            <!--<div class="top mui-row">
                <div class="mui-col-sm-12 mui-col-xs-12">
                    <a data-type="0" href="javascript:void(0)">我的课程表</a>
                </div>
            </div>-->
            <!-- 顶栏-->
            <!--<div class="top mui-row">-->
            <!--<div class="mui-col-sm-4 mui-col-xs-4">-->
            <!--<a href="#">培训订单</a>-->
            <!--</div>-->
            <!--<div class="cl1"></div>-->
            <!--<div class="mui-col-sm-4 mui-col-xs-4">-->
            <!--<a href="#">历史培训</a>-->
            <!--</div>-->
            <!--<div class="cl2"></div>-->
            <!--<div class="mui-col-sm-4 mui-col-xs-4">-->
            <!--<a href="#"  class="active">课程表</a>-->
            <!--</div>-->
            <!--</div>-->
            <!-- 顶栏-->
            <!--<div class="blank"></div>-->
            <div class="course">
                <!--进行中-->
                <div class="ongoing">
                    <p></p>
                </div>
                <!--进行中-->

                <!--课程的具体情况-->
                <div id="model-list-panel" class="mui-scroll-wrapper order">
                    <div class="mui-scroll">
                        <div id="model-list">
                            <!--<div class="specific">
                                <div class="info">
                                    <div class="info-m">
                                        <p>2017-01-30 19:00-20:30</p>
                                        <h3>2017暑期少儿艺术公益培训班（1）</h3>
                                        <p class="address">
                                            <i class="icon iconfont icon-location"></i>
                                            <span>广东省文化服务中心</span>
                                        </p>
                                        <p class="vary">已请假</p>
                                        <button>取消</button>
                                        <div class="round">
                                            <div class="round-m"></div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            &lt;!&ndash;课程的具体情况&ndash;&gt;

                            &lt;!&ndash;课程的具体情况&ndash;&gt;
                            <div class="specific">
                                <div class="info">
                                    <div class="info-m">
                                        <p>2017-01-30 19:00-20:30</p>
                                        <h3>2017暑期少儿艺术公益培训班（1）</h3>
                                        <p class="address">
                                            <i class="icon iconfont icon-location"></i>
                                            <span>广东省文化服务中心</span>
                                        </p>
                                        &lt;!&ndash; <p class="vary">已请假</p>&ndash;&gt;
                                        <button class="change">请假</button>
                                        <div class="round">
                                            <div class="round-m"></div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            &lt;!&ndash;课程的具体情况&ndash;&gt;

                            &lt;!&ndash;课程的具体情况&ndash;&gt;
                            <div class="specific">
                                <div class="info">
                                    <div class="info-m">
                                        <p>2017-01-30 19:00-20:30</p>
                                        <h3>2017暑期少儿艺术公益培训班（1）</h3>
                                        <p class="address">
                                            <i class="icon iconfont icon-location"></i>
                                            <span>广东省文化服务中心</span>
                                        </p>
                                        <p class="vary">请假被驳回</p>
                                        <button class="change">查看</button>
                                        <div class="round">
                                            <div class="round-m"></div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            &lt;!&ndash;课程的具体情况&ndash;&gt;

                            &lt;!&ndash;课程的具体情况&ndash;&gt;
                            <div class="specific">
                                <div class="info">
                                    <div class="info-m">
                                        <p>2017-01-30 19:00-20:30</p>
                                        <h3>2017暑期少儿艺术公益培训班（1）</h3>
                                        <p class="address">
                                            <i class="icon iconfont icon-location"></i>
                                            <span>广东省文化服务中心</span>
                                        </p>
                                        <p class="vary">请假审核中</p>
                                        <button>取消</button>
                                        <div class="round">
                                            <div class="round-m"></div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            &lt;!&ndash;课程的具体情况&ndash;&gt;

                            &lt;!&ndash;课程的具体情况&ndash;&gt;
                            <div class="specific">
                                <div class="info">
                                    <div class="info-m">
                                        <p>2017-01-30 19:00-20:30</p>
                                        <h3>2017暑期少儿艺术公益培训班（1）</h3>
                                        <p class="address">
                                            <i class="icon iconfont icon-location"></i>
                                            <span>广东省文化服务中心</span>
                                        </p>
                                        &lt;!&ndash; <p class="vary">已请假</p>&ndash;&gt;
                                        <button class="change">请假</button>
                                        <div class="round">
                                            <div class="round-m"></div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            &lt;!&ndash;课程的具体情况&ndash;&gt;-->
                        </div>
                    </div>
                </div>
            </div>
            <!--课程表-->
        </div>
    </div>
</div>
<!--请假弹出框-->
<div class="message-box-bg" style="display: none">
    <div class="message-cont">
        <h2>请假申请</h2>
        <p><i class="icon iconfont icon-prompt"></i>培训名称：<span id="cTitle"></span></p>
        <p><i class="icon iconfont icon-time"></i>上课时间：<span id="cTime"></span></p>
        <!--有审核结果则显示结果-->
        <p class="msg m-1" id="courseMessage"><i class="icon iconfont icon-message"></i>审核结果：<span></span></p>
        <textarea placeholder="请输入你的请假事由" id="courseMsg" name="message" maxlength="500"></textarea>
        <!--审核中、审核通过，不显示该按钮-->
        <div class="message-btn">
            <a hrer="javascript" class="btn">提交</a>
        </div>
    </div>
    <input type="hidden" name="courseid">
    <input type="hidden" name="traid">
    <input type="hidden" name="title">
    <input type="hidden" name="starttime">
    <input type="hidden" name="endtime">
    <div class="msg-close"></div>
</div>
<!--底部开始-->
<script type="text/javascript" th:inline="javascript">
    var userId = $("#temp_userId").val();
    var serviceTime = "",flag = true ,latitude, longitude;
    //获取所有正在上课的课程数据

    $().ready(function () {
        trainDataIn();
        modelData();
    })

    function trainDataIn() {
        var params = {
            userid: userId,
            cultid: $.cookie('cultid')
        }
        dataInit.ajax({
            api: [[${apiPath.inClass}]],
            params: params,
            fn: function (data) {
                createTrainIn(data);
            }
        })
    }

    //生成正在上课的课程滚动通知
    function createTrainIn(data) {
        var panel = $(".ongoing");
        panel.html("");
        if (data.code == 0 && data.data.length > 0) {
            $(".order").css({
                top: "66px"
            })
            for (var i in data.data) {
                var model = data.data[i];
                panel.append('<p>正在上课：' + model.title + '</p>');
            }
        } else {
            $(".order").css({
                top: "10px"
            })
            panel.hide();
        }
    }

    function clearModel(){
        $("#model-list").empty();
    }

    function modelData(page, size) {
        var page = page || 1;
        var size = size || 10;
        dataInit.ajax({
            api: [[${apiPath.wxKeCheng}]],
            params: {
                page: page,
                pageSize: size,
                userid: userId,
                cultid: $.cookie('cultid')
            },
            forceUpdate: false,
            fn: function (data) {
                var params = {
                    page: page,
                    size: size,
                    total: data.total
                }
                dataInit.htmlAdd(page, showModelHtml(data));
                dataInit.pullUp(params, modelData);
                mui(".info-m").on('tap', '.state', function (event) {
                    this.click();
                });
            }
        })
    }

    function showModelHtml(data) {
        if (data && data.code == 0) {
            var html = '';
            if (data.code == 0 && data.rows.length > 0) {
                serviceTime = data.data;

                //参照时间往后半小时的时间
                var timeOn30 = data.data + (1000*60*30);

                for (var i=0; i< data.rows.length; i++) {
                    var model = data.rows[i];
                    var state = model.vstate;
                    var stateCls = '';
                    var stateTxt = '';
                    var startTime = moment(model.starttime).format('YYYY-MM-DD HH:mm');
                    var endTime = moment(model.endtime).format('HH:mm');
                    var time = startTime + "-" + endTime;

                    var title = '';
                    //alert(model.islive);
                    if(model.islive == 1){
                        title = model.title+'（第'+(i+1)+'课）';
                    }else{
                        title = model.title;
                    }
                    var btnCls = "none",signCls = '',btnCls2='none';
                    //0-未开始, 1-正在直播, 2-已结束;
                    var btnTxt = "";
                    var listState = 0;
                    if(model.islive == 1){
                        if(model.isover > 0){
                            listState = 2;
                        }else if(model.liveing == 1){
                            listState = 1;
                        }else{
                            listState = 0;
                        }

                        if(listState == 0){
                            btnCls = 's-3';
                            btnCls2 = '';
                            btnTxt = '直播未开始';
                        }else if(listState == 1){
                            btnCls = 's-1';
                            btnTxt = '进入直播';
                            // livelink = '<a href="liveNow?id='+rowid+'" class="liveNow-a"></a>';
                        }else if(listState == 2){
                            btnCls = 's-4';
                            btnTxt = '查看回顾';
                            // livelink = '<a href="liveNow?id='+rowid+'" class="liveNow-a"></a>';
                        }
                    }
                    var em = "";
                    var end = "";
                    var click = "javascript:void(0)"
                    switch (state) {
                        case 0:
                            stateTxt = "请假申请中";
                            stateCls = 's-2';
                            signCls = 'none';
                            break;
                        case 1:
                            stateTxt = "已请假";
                            stateCls = 's-2';
                            signCls = 'none';
                            break;
                        case 2:
                            stateTxt = "请假失败";
                            stateCls = 's-1';
                            click = 'openDialog(' + model.id + ')';
                            break;
                        default:
                            stateTxt = "请假";
                            stateCls = 's-1';
                            click = 'openDialog(' + model.id + ')';
                    }
                    if (model.starttime > serviceTime) {
                        btnCls = "";
                    }
                    if (model.endtime < serviceTime) {
                        end = "end";
                        signCls = 'none';
                    }
                    //if(model.starttime>serviceTime){
                    if (model.starttime >= timeOn30) {
                        signCls = 'none';
                    }
                    if(model.sign == 1){
                        btnCls = "none";
                    }
                    var sign = model.sign;
                    var signState = "签到";
                    if(sign == 1){
                        signState = "已签到";
                    }
                    var address = model.address?model.address:'';
                    var addressNone = model.address?'':'none';
                    html += '<div class="specific">\
                                    <div class="info">\
                                        <div class="info-m">\
                                            <p>' + time + '</p>\
                                            <h3>' + title + '</h3>\
                                            <p class="address '+addressNone+'">\
                                                <i class="icon iconfont icon-location"></i>\
                                                <span>'+address+'</span>\
                                            </p>\
                                            <div class="state ' + stateCls + ' ' + btnCls + '" onclick="' + click + '">' + stateTxt + '</div>\
                                            <div class="state '+signCls+'" onclick="wxSign(\''+model.id+'\',\''+model.enrolid+'\')">'+signState+'</div>\
                                            <div class="state '+btnCls2+'">'+btnTxt+'</div>\
                                            <div class="round">\
                                                <div class="round-m"></div>\
                                            </div>\
                                        </div>\
                                    </div>\
                             </div>';
                }
            } else {
                html = "<div class='newbility-no-msg'></div>";
            }
            return html;
        } else {
            mui.toast(data.msg || '获取订单信息失败')
        }
    }

    //打开请假弹出框
    function openDialog(id) {
        $('.message-box-bg').fadeIn();
        courseDate(id);
        $(window).keyup(function (e) {
            if (e.keyCode == 27) {
                $('.message-box-bg').fadeOut();
            }
        });
        $('.msg-close').on('click', function () {
            $('.message-box-bg').fadeOut();

        })
        $('.message-btn .btn').on('click',function(){
            var _courseMsg = $("#courseMsg").val();
            var courseMsg  = _courseMsg.replace(/(^\s*)|(\s*$)/g, "");
            if(!courseMsg && courseMsg == ""){
                mui.toast("请填写请假事由");
                return;
            }
            var params = {
                traid : $("input[name='traid']").val(),
                userid:userId,
                courseid : $("input[name='courseid']").val(),
                title :  $("input[name='title']").val(),
                starttime :  $("input[name='starttime']").val(),
                endtime :  $("input[name='endtime']").val(),
                name : $("#temp_nickName").val(),
                cause : $("#courseMsg").val()
            }
            getCourse(params);
        })
    }

    //查询单个课程的详情信息
    function courseDate(id){
        dataInit.ajax({
            api:[[${apiPath.traliveInfo}]],
            params:{
                userId:userId,
                id:id
            },
            fn:function(data){
                initCourseDate(data);
            }
        })
    }

    //初始化请假详情信息
    function initCourseDate(data){
        if(data.code == 0){
            var model = data.data;
            var title = model.title;
            var starttime = moment(model.starttime).format('YYYY-MM-DD HH:mm');
            var endtime = moment(model.endtime).format('HH:mm');
            var time =starttime + ' - '+endtime;
            $("#cTitle").text(title);
            $("#cTime").text(time);
            $("input[name='courseid']").val(model.id);
            $("input[name='traid']").val(model.traid);
            $("input[name='title']").val(title);
            $("input[name='starttime']").val(model.starttime);
            $("input[name='endtime']").val(model.endtime);
            if(model.applyLeaveSuggest){
                $("#courseMessage span").text(model.applyLeaveSuggest);
                $("#courseMessage").show();
                $(".message-btn a").text("重新提交");
            }else{
                $("#courseMessage").hide();
                $(".message-btn a").text("提交")
            }
        }
    }

    //提交请假单
    function getCourse(params){
        if(flag){
            flag = false;
            dataInit.ajax({
                api:[[${apiPath.leave}]],
                params:params,
                fn:function(data){
                    $('.message-box-bg').fadeOut();
                    if(data.code == 0){
                        mui.toast("申请已提交");
                        $("#model-list").html("");
                        flag = true;
                        clearModel();
                        modelData();
                    }else{
                        mui.toast(data.msg || "申请提交异常");
                        flag = true;
                    }
                    $("#courseMsg").val("")
                }
            })
        }
    }

    /**
     *签到提交
    * 培训课程签到  POST请求
    * 访问路径 /api/mytra/sign
    * @param orderid 订单id
    * @param courseid 课程id
    * @param longitude 经度
    * @param latitude 纬度
    **/
    function wxSign(id,orderid) {

        if (dataInit.isWeixin()) {
            wx.getLocation({
                type: 'gcj02', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
                dataType:"json",
                success: function (res) {
                    latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
                    longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
                    // var speed = res.speed; // 速度，以米/每秒计
                    // var accuracy = res.accuracy; // 位置精度
//                alert('lat: ' + latitude + ' lng: ' + longitude);
                    var params = {
                        courseid :id,
                        orderid:orderid,
                        // userid:userId,
                        latitude:latitude,
                        longitude:longitude
                    }
                    dataInit.ajax({
                        api: [[${apiPath.wxKeChengSign}]],
                        params: params,
                        fn: function (data) {
                            if(data.code == 0){
                                mui.toast('签到成功！');
                                clearModel();
                                modelData();
                            }else {
                                mui.toast(data.msg ||'签到失败')
                            }
                        }
                    })
                },
                cancel: function (res) {
                    mui.toast('用户拒绝授权获取地理位置')
                },
                fail: function (res) {
                    mui.toast('请您打开手机定位功能再签到！')
                }
            });
        }else {
            mui.toast('请在微信中使用');
        }

    }
</script>
</body>
</html>