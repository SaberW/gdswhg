<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head th:include="guangdong/public/resource :: copy"></head>
<body>
<link rel="stylesheet" th:href="${basePath}+'/assets/css/usercenter/usercenter.css'" >
<link rel="stylesheet" th:href="${basePath}+'/assets/css/public/detail.css'" >
<link rel="stylesheet" th:href="${basePath}+'/assets/js/picker/css/mui.picker.css'">
<script th:src="${basePath}+'/assets/js/picker/js/mui.picker.min.js'" type="text/javascript"></script>
<div th:include="guangdong/public/leftBar :: copy"></div>
<div id="page">
    <div class="mui-content">
        <!--实名认证-->
        <div class="certification breadth" id="cont-1" style="display: none">
            <div class="mui-input-group">
                <div class="mui-input-row">
                    <label>姓 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名</label>
                    <input type="text" maxlength="15" minlength="2" id="realName" name="realName" class="mui-input-clear" placeholder="请输入您的姓名">
                </div>
                <ul class="mui-table-view">
                    <li class="mui-table-view-cell padding15px" id="idcardtype">
                        <div class="mui-pull-left">证件类型</div>
                        <div class="mui-pull-right"></div>
                    </li>
                </ul>
                <div class="mui-input-row">
                    <label>身份证号</label>
                    <input type="text" maxlength="18" minlength="18" id="userCode" name="userCode" class="mui-input-clear"  placeholder="请输入您的身份证号">
                </div>
                <ul class="mui-table-view">
                    <li class="mui-table-view-cell padding15px" id="_birthday" style="display: none">
                        <div class="mui-pull-left">出生日期</div>
                        <div class="mui-pull-right"></div>
                    </li>
                </ul>
                <ul class="mui-table-view">
                    <li class="mui-table-view-cell padding15px" id="sex">
                        <div class="mui-pull-left">性别</div>
                        <div class="mui-pull-right"></div>
                    </li>
                </ul>
            </div>
            <div class="ident">
                <div class="photo">
                    <div class="photo-l" id="imgFront">
                        <p>点击上传<br/>（国徽面照片）</p>
                    </div>
                    <div class="photo-r">
                        <img class="lazy" id="imgFront-image" th:src="${basePath}+'/assets/img/usercenter/imgFront.png'"/>
                    </div>
                </div>

                <div class="photo">
                    <div class="photo-l" id="imgBack">
                        <p>点击上传<br/>（人像面照片）</p>
                    </div>
                    <div class="photo-r">
                        <img class="lazy" id="imgBack-image" th:src="${basePath}+'/assets/img/usercenter/imgBack.png'"/>
                    </div>
                </div>

                <!--<div class="photo">
                    <div class="photo-l" id="imgHand">
                        <p>点击上传<br/>（手持身份证）</p>
                    </div>
                    <div class="photo-r">
                        <img class="lazy" id="imgHand-image" src="http://mpic.tiankong.com/620/378/62037850a1c3780a91357c521f4b8fe1/640.jpg"/>
                    </div>
                </div>-->

                <div class="info">
                    <p class="cue">提示： 身份证上的信息清晰可见</p>
                    <p>身份证号码必须清晰可识别</p>
                    <p>图片大小不超过2M</p>
                </div>
            </div>
            <nav class="mui-bar mui-bar-tab" id="okNext">
                <div class="mui-tab-item">
                    <a class="goNext" href="javascript:void(0)" id="btn-1">提交</a>
                </div>
            </nav>
        </div>
        <!--实名认证-->

        <!--实名认证审核中-->
        <div class="examine breadth"  id="cont-2" style="display: none">
            <!--<div class="check">-->
                <!--<div class="check-m mui-table-view">-->
                    <!--<div class="tag">-->
                        <!--<div class="img">-->
                            <!--<img class="lazy" th:src="${basePath}+'/assets/img/usercenter/waiting@3x.png'"/>-->
                        <!--</div>-->
                    <!--</div>-->
                    <!--<ul class="mui-table-view">-->
                        <!--<li class="mui-table-view-cell hide">-->
                            <!--<span class="mui-pull-left">真实姓名 :</span>-->
                            <!--<span class="mui-pull-right">何某某</span>-->
                        <!--</li>-->
                        <!--<li class="mui-table-view-cell">-->
                            <!--<span class="mui-pull-left">身份证号 :</span>-->
                            <!--<span class="mui-pull-right">430681199112026455</span>-->
                        <!--</li>-->
                        <!--<li class="mui-table-view-cell">-->
                            <!--<span class="mui-pull-left">认证时间 :</span>-->
                            <!--<span class="mui-pull-right">2017-01-27 &nbsp; 20:00</span>-->
                        <!--</li>-->
                        <!--<li class="mui-table-view-cell">-->
                            <!--<span class="mui-pull-left">认证状态 :</span>-->
                            <!--<span class="mui-pull-right change">认证审核中</span>-->
                        <!--</li>-->
                        <!--<li class="mui-table-view-cell">-->
                            <!--<span class="mui-pull-left">失败原因 :</span>-->
                            <!--<span class="mui-pull-right">长得不好看,请去韩国整容</span>-->
                        <!--</li>-->
                    <!--</ul>-->
                <!--</div>-->
            <!--</div>-->
        </div>
        <nav class="mui-bar mui-bar-tab" id="goNext" style="display: none">
            <div class="mui-tab-item">
                <a class="goNext" href="javascript:void(0)">重新提交</a>
            </div>
        </nav>
        <!--实名认证审核中-->

        <!--实名认证失败-->
        <!--<div class="failed breadth">
            <div class="check">
                <div class="check-m mui-table-view">
                    <div class="tag">
                        <div class="img">
                            <img class="lazy" th:src="${basePath}+'/assets/img/usercenter/failed@3x.png'"/>
                        </div>
                    </div>
                    <ul class="mui-table-view">
                        <li class="mui-table-view-cell hide">
                            <span class="mui-pull-left">真实姓名 :</span>
                            <span class="mui-pull-right">何某某</span>
                        </li>
                        <li class="mui-table-view-cell">
                            <span class="mui-pull-left">身份证号 :</span>
                            <span class="mui-pull-right">430681199112026455</span>
                        </li>
                        <li class="mui-table-view-cell">
                            <span class="mui-pull-left">认证时间 :</span>
                            <span class="mui-pull-right">2017-01-27 &nbsp; 20:00</span>
                        </li>
                        <li class="mui-table-view-cell">
                            <span class="mui-pull-left">认证状态 :</span>
                            <span class="mui-pull-right change">认证失败</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>-->
        <!--实名认证失败-->

    </div>
</div>
<script type="text/javascript" th:inline="javascript">
    var userId = $("#temp_userId").val();
    var name,idCard,authIDPic = ['', ''],authIDMedia = ['', ''];
    var _birthday = '';
    $().ready(function(){
        userDataInit();
        mui(".mui-tab-item").on("tap","#btn-1",function(){
            goNext()
        })
        initPictureEvent();
        initSexItem();
        initIdcardtypeItem();
        if($('#idcardtype .mui-pull-right').text() == '港澳台'){
            $('#_birthday').show();
        }else{
            $('#_birthday').hide();
        }
    });
    var sex='1';
    function initSexItem(){
        mui(".mui-table-view").on('tap',"#sex",function () {
            var picker = new mui.PopPicker();
            picker.setData([{value: '1', text: '男'}, {value: '0', text: '女'}]);
            picker.show(function (selectItems) {
                sex = selectItems[0].value;
                $('#sex .mui-pull-right').text(selectItems[0].text);
            });
        })
    }
    var idcardtype = 1;
    function initIdcardtypeItem(){
        mui(".mui-table-view").on('tap',"#idcardtype",function () {
            var picker = new mui.PopPicker();
            picker.setData([{value: 1, text: '中国大陆'}, {value: 2, text: '港澳台'}]);
            picker.show(function (selectItems) {
                idcardtype = selectItems[0].value;
                $('#idcardtype .mui-pull-right').text(selectItems[0].text);
                if(idcardtype == 2){
                    $('#_birthday').show();
                }else{
                    $('#_birthday').hide();
                    $('#_birthday .mui-pull-right').text('');
                }
            });
        });
        mui(".mui-table-view").on('tap',"#_birthday",function () {
            var dtPicker = new mui.DtPicker({
                type: 'date',
                beginDate:new Date(1900,0)
            });
            dtPicker.show(function (selectItems) {
                $('#_birthday .mui-pull-right').text(selectItems.value);
            });
        })
    }

    function verification() {
        var reg = /^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}([0-9]|X|x)$/;
        _birthday = $('#_birthday .mui-pull-right').text();
        if($("#realName").val().length < 2) {
            mui.toast("请输入您的真实姓名");
            return false;
        }else if($.trim($("#userCode").val())==''){
            mui.toast("请输身份证号码");
            return false;
        }else if(idcardtype!=2 && !reg.test($("#userCode").val())){
            mui.toast("请输入正确的身份证号码");
            return false;
        }else if(idcardtype==2 && !_birthday){
            mui.toast("请输入出生日期");
            return false;
        }else{
            name = $("#realName").val();
            idCard = $("#userCode").val();
            return true;
        }
    }

    function goNext(){
        if(verification()){
            initAuthIDEvent();
        }
    }

    function initPictureEvent() {
        mui('.photo').on('tap', '#imgFront', function () {
            wx.chooseImage({
                count: 1,
                sizeType: ['compressed'],
                sourceType: ['album', 'camera'],
                success: function (res) {
                    authIDPic[0] = res.localIds[0];
                    $('#imgFront-image').attr('src', res.localIds[0]);
                }
            });
        });
        mui('.photo').on('tap', '#imgBack', function () {
            wx.chooseImage({
                count: 1,
                sizeType: ['compressed'],
                sourceType: ['album', 'camera'],
                success: function (res) {
                    authIDPic[1] = res.localIds[0];
                    $('#imgBack-image').attr('src', res.localIds[0]);
                }
            });
        });
    }

    function initAuthIDEvent() {
        if (authIDPic[0].length == 0 || authIDPic[1].length == 0) {
            mui.toast('请按图示上传证件照');
        }
        else {
            var i = 0, length = authIDPic.length;
            function upload() {
                wx.uploadImage({
                    localId: authIDPic[i],
                    success: function (res) {
                        authIDMedia[i] = res.serverId;
                        i++;
                        if (i < length) {
                            upload();
                        }
                        else {
                            getResource(authIDMedia);
                        }
                    },
                    fail: function (res) {
                        mui.toast(JSON.stringify(res));
                    }
                });
            }
            upload();
        }
    }

    function getResource(files){
        var params = {
            fileCount:files.length.toString(),
            imageName1:files[0],
            imageName2:files[1]
        }
        //params.fileCount = files.length.toString();
//        for (var i = 0; i < files.length; i++) {
//            params.push(makeParameter('imageName' + (i + 1), files[i]));
//        }
        //console.log(params);
        dataInit.ajax({
            api:[[${apiPath.getResource}]],
            params:params,
            fn:function(data){
                if(data.code == 0) {
                    updateAuth(data.data);
                }else{
                    mui.toast( data.msg || "图片保存失败");
                }
            }
        })
    }

    function makeParameter(name, value) {
        var p = new Array(2);
        p[0] = name;
        p[1] = value;
        return p;
    }

    function updateAuth(data) {
        var urlFront = data[0].url;
        var urlBack = data[1].url;
        var params = {
            'id':userId,
            'name':name,
            'idcard':idCard,
            'idcardface':urlFront,
            'idcardback':urlBack,
            'sex': sex,
            'idcardtype': idcardtype
        };
        if(idcardtype == 2){
            params._birthday = _birthday;
        }
        dataInit.ajax({
            api:[[${apiPath.authVerify}]],
            params:params,
            fn:function(data){
                if(data.code == 0){
                    mui.toast("实名认证信息已提交，请耐心等待管理员审核");
                    window.location.reload();
                }else{
                    mui.toast( data.msg || "信息提交失败");
                }
            }
        })
    }

    //用户数据初始化
    function userDataInit(){
        dataInit.ajax({
            api:[[${apiPath.userInfo}]],
            params:{
                userId:userId
            },
            fn:function(data){
                if(data.code === 0){
                    var model = data.data;

                    if(model.authState != 0 && model.authState){
                        $("#cont-1").hide();
                        $("#cont-2").show();
                    }else{
                        $("#cont-1").show();
                        $("#cont-2").hide();
                    }
                    //0-待完善; 1-已认证;  2-认证失败; 3-提交审核中
                    var state = '';
                    var img = [[${basePath}]]+'/assets/img/usercenter/waiting@3x.png';
                    switch(model.authState){
                        case 1:
                            img = [[${basePath}]]+'/assets/img/usercenter/yes@3x.png';
                            state = '已认证';
                            break;
                        case 2:
                            img = [[${basePath}]]+'/assets/img/usercenter/failed@3x.png';
                            state = '认证失败';
                            $("#goNext").show();
                            mui('.mui-tab-item').on('tap','.goNext',function(){
                                $("#cont-1").show();
                                $("#cont-2").hide();
                                $("#goNext").hide();
                                if($('#idcardtype .mui-pull-right').text() == '港澳台'){
                                    $('#_birthday').show();
                                }else{
                                    $('#_birthday').hide();
                                }
                            });
                            break;
                        case 3:
                            state = '审核中'
                            break;
                        default:
                            state = '资料待完善'
                    }
                    var desc = '';
                    var descCls = 'none';
                    if(model.checkmsg && model.authState == 2) {
                        desc = model.checkmsg;
                        descCls = '';
                    }
                    sex = model.sex;
                    $('#sex .mui-pull-right').text(sex == '1'? '男': '女');
                    idcardtype = model.idcardtype;
                    $('#idcardtype .mui-pull-right').text(idcardtype == '2'? '港澳台': '中国大陆');

                    var idcard = model.idCard;
                    if (model.authState == 1){
                        var mln = idcard.length;
                        if (mln>3){
                            var cln = Math.ceil(mln/2);
                            var idx = cln==1? cln : Math.floor(cln/2);
                            var cxxx = '';
                            var reg = new RegExp("^(.{"+idx+"})(.*)(.{"+idx+"})$");
                            if (reg.test(idcard)){
                                var cnum = RegExp.$2.length;
                                while(cxxx.length < cnum){
                                    cxxx+='*';
                                }
                            }
                            idcard = idcard.replace(reg, '$1'+cxxx+'$3');
                        }
                    }
                    var html = '<div class="check">\
                                <div class="check-m mui-table-view">\
                                    <div class="tag">\
                                        <div class="img">\
                                            <img class="lazy" src="'+img+'"/>\
                                        </div>\
                                    </div>\
                                    <ul class="mui-table-view">\
                                        <li class="mui-table-view-cell hide">\
                                            <span class="mui-pull-left">真实姓名 :</span>\
                                            <span class="mui-pull-right">'+model.realName+'</span>\
                                        </li>\
                                        <li class="mui-table-view-cell">\
                                            <span class="mui-pull-left">证件类型 :</span>\
                                            <span class="mui-pull-right">'+(model.idcardtype==2?'港澳台':'中国大陆')+'</span>\
                                        </li>\
                                        <li class="mui-table-view-cell">\
                                            <span class="mui-pull-left">身份证号 :</span>\
                                            <span class="mui-pull-right">'+idcard+'</span>\
                                        </li>'+
                                        (idcardtype == '2' ?
                                            '<li class="mui-table-view-cell">' +
                                            '   <span class="mui-pull-left">出生日期 :</span>' +
                                            '   <span class="mui-pull-right">'+moment(model.birthday).format('YYYY-MM-DD')+'</span>' +
                                            '</li>':''
                                        )+
                                        ' <li class="mui-table-view-cell">\
                                            <span class="mui-pull-left">性别 :</span>\
                                            <span class="mui-pull-right">'+(model.sex=='1'?'男':'女')+'</span>\
                                        </li>\
                                        <li class="mui-table-view-cell">\
                                            <span class="mui-pull-left">认证状态 :</span>\
                                            <span class="mui-pull-right change">'+state+'</span>\
                                        </li>\
                                        <li class="mui-table-view-cell '+descCls+'">\
                                            <span class="mui-pull-left">失败原因 :</span>\
                                            <span class="mui-pull-right">'+desc+'</span>\
                                        </li>\
                                    </ul>\
                                </div>\
                            </div>';

                    $("#cont-2").html(html);
                }
            }
        })
    }

</script>
</body>
</html>