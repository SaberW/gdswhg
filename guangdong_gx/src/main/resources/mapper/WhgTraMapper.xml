<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.creatoo.hn.dao.mapper.WhgTraMapper">

    <select id="selTraList" resultType="hashmap">
        SELECT
            t1.*
        FROM
            whg_tra t1
        WHERE
            t1.id NOT IN (
                SELECT
                    c1.entid
                FROM
                    whg_major_contact c1
                WHERE
                    c1.type = 1
                    AND c1.majorid = #{mid}
            )
        AND t1.state = 6
        AND t1.cultid = #{cultid}
        AND t1.delstate = 0
        AND t1.biz = 'PT'
        order by t1.statemdfdate desc
    </select>


    <select id="t_srchTraList" resultType="hashmap">
        SELECT
        t1.*
        FROM
        whg_tra t1
        WHERE

        t1.state = 6
        AND t1.delstate = 0
        AND t1.biz = 'PT'
        AND t1.islive = 0
    </select>

    <select id="selectPxOrder4BlackListCheck" resultType="hashmap">
        select * from (
            SELECT
            c.crtdate,
            c.crtuser,
            c.delstate,
            c.endtime,
            c.id,
            c.starttime,
            c.state,
            c.statemdfdate,
            c.statemdfuser,
            c.traid,
            e.id AS enrolid,
            u.id AS userid,
            t.title AS title,
            u.phone AS phone,
            tec.sign,
            qj.state AS qjstate
            FROM
            whg_usr_blacklist ubl
            RIGHT JOIN whg_user u on ubl.userid = u.id
            INNER JOIN whg_tra_enrol e on u.id = e.userid
            INNER JOIN whg_tra t on e.traid = t.id
            INNER JOIN whg_tra_course c on t.id = c.traid
            LEFT JOIN whg_tra_enrol_course tec ON tec.courseid = c.id
            LEFT JOIN whg_traleave qj on tec.courseid = qj.courseid

            where tec.userid = u.id

            <if test="actType != null and actType == 'ZC'">
                AND t.biz ='ZC'
            </if>
            <if test="actType != null and actType == 'PX'">
                AND t.biz ='PT'
            </if>

            AND ( ubl.updatetime IS NULL OR c.endtime > ubl.updatetime)
            AND ( ubl.jointime IS NULL OR c.endtime > ubl.jointime )
            AND e.state = 6
            AND c.state = 1

            AND c.endtime &lt; #{now}
            AND (tec.sign IS NULL OR tec.sign = 0)
            GROUP BY c.id
        ) as tempview
        WHERE 1 = 1
        GROUP BY tempview.userid
        HAVING count(tempview.id) >= #{checkNumber}
        and tempview.userid not in (
          select userid from whg_usr_blacklist where userid = tempview.userid
          and (state = 1 or (state=0 and updatetime is not NULL) )
        )
        and (tempview.qjstate is null OR tempview.qjstate = 0)

    </select>




    <select id="selectPxSign4BlackListCheck" resultType="hashmap">
        SELECT * FROM
        (
            SELECT
            enrol.*,
            u.phone AS phone,
            tra.id AS tid
            FROM
            whg_usr_blacklist ubl
            RIGHT JOIN whg_user u ON u.id = ubl.userid
            INNER JOIN whg_tra_enrol enrol ON enrol.userid = u.id
            INNER JOIN whg_tra tra ON enrol.traid = tra.id
            WHERE
            enrol.state = 2
            <if test="actType != null and actType == 'ZC'">
                AND tra.biz ='ZC'
            </if>
            <if test="actType != null and actType == 'PX'">
                AND tra.biz ='PT'
            </if>
            and (ubl.updatetime is null or tra.endtime > ubl.updatetime)
            and (ubl.jointime is null or tra.endtime > ubl.jointime)

            GROUP BY enrol.id
        ) AS tempview
        WHERE 1 = 1
        GROUP BY tempview.userid
        HAVING
        count(tempview.id) >= ${unenrolcount}
        AND tempview.userid NOT IN (
            SELECT userid FROM whg_usr_blacklist
            WHERE userid = tempview.userid
            AND (state = 1 or (state=0 and updatetime is not NULL) )
        )
    </select>
</mapper>